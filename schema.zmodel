// SchÃ©ma Zenstack - Faso Fret Logistics
// Application de gestion de fret multi-modal avec Access Control

/**
 * Generator Prisma standard
 * GÃ©nÃ¨re les binaires pour Linux (Vercel) et le systÃ¨me local
 */
generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
  moduleFormat  = "esm"
}

/**
 * Plugin Zenstack pour hooks React Query
 */
plugin hooks {
  provider = '@zenstackhq/tanstack-query'
  target = 'react'
  version = 'v5'
  output = "../src/lib/hooks"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CONTEXTE D'AUTHENTIFICATION
// ============================================

/**
 * Type Auth - DÃ©finit la forme du contexte utilisateur pour Zenstack
 *
 * CRITIQUE : Ce type est obligatoire pour que Zenstack comprenne la structure
 * de auth() utilisÃ©e dans les access policies.
 *
 * Sans ce type, auth().role, auth().id, etc. ne fonctionnent PAS correctement
 * et les policies sont rejetÃ©es mÃªme si l'utilisateur a les bonnes permissions.
 *
 * Le contexte est fourni via enhance(prisma, { user: context })
 */
type Auth {
  id       String   @id      // ID de l'utilisateur (depuis Better Auth)
  role     UserRole          // RÃ´le de l'utilisateur (ADMIN, CLIENT, etc.)
  clientId String?           // ID du client (COMPANY ou INDIVIDUAL) pour multi-tenancy

  @@auth                      // Directive Zenstack : marque ce type comme contexte auth()
}

// ============================================
// AUTHENTIFICATION (Better Auth)
// ============================================

/**
 * ModÃ¨le User avec access control
 * - ADMIN : accÃ¨s complet Ã  tous les users
 * - OPERATIONS_MANAGER/FINANCE_MANAGER : peuvent lire les users de leur entreprise
 * - CLIENT/VIEWER : peuvent lire uniquement leur propre profil
 * - Tous les users peuvent modifier leur propre profil
 */
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified Boolean   @default(false) // Better Auth: Boolean au lieu de DateTime
  name          String?
  image         String?
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations Better Auth
  accounts Account[]
  sessions Session[]

  // Champs business
  role        UserRole @default(CLIENT)
  clientId    String?  // ID du client (COMPANY ou INDIVIDUAL) - NULL uniquement pour ADMIN systÃ¨me
  client      Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  permissions Json?

  // Relations
  createdShipments   Shipment[] @relation("CreatedBy")
  userDocuments      Document[] @relation("UserDocuments")   // Documents de cet utilisateur
  uploadedDocuments  Document[] @relation("UploadedDocuments")
  prospect           Prospect?  // Relation 1:1 avec Prospect (si converti)
  pricingConfigs     PricingConfig[] // Configurations de prix modifiÃ©es par cet utilisateur
  createdPickups     PickupRequest[] @relation("CreatedPickups") // Demandes d'enlÃ¨vement crÃ©Ã©es
  pickupLogs         PickupLog[] @relation("PickupLogChangedBy") // Logs d'enlÃ¨vement effectuÃ©s
  userPickups        PickupRequest[] @relation("UserPickups") // Demandes d'enlÃ¨vement de cet utilisateur (connectÃ© ou rattachÃ©)

  createdPurchases   PurchaseRequest[] @relation("CreatedPurchases") // Demandes d'achat crÃ©Ã©es
  purchaseLogs       PurchaseLog[] @relation("PurchaseLogChangedBy") // Logs d'achat effectuÃ©s
  userPurchases      PurchaseRequest[] @relation("UserPurchases") // Demandes d'achat de cet utilisateur (connectÃ© ou rattachÃ©)
  quoteLogs          QuoteLog[] @relation("QuoteLogChangedBy") // Logs de devis effectuÃ©s
  shipmentLogs       ShipmentLog[] @relation("ShipmentLogChangedBy") // Logs d'expÃ©dition effectuÃ©s

  treatedQuotes      Quote[] @relation("QuoteTreatmentAgent") // Devis traitÃ©s par cet agent

  performedTrackingEvents TrackingEvent[] @relation("PerformedTrackingEvents") // Ã‰vÃ©nements de tracking effectuÃ©s par cet agent

  // Relations pour les devis (pattern crÃ©ation sans compte)
  userQuotes         Quote[] @relation("UserQuotes")    // Devis rattachÃ©s Ã  cet utilisateur
  createdQuotes      Quote[] @relation("CreatedQuotes") // Devis crÃ©Ã©s par cet utilisateur

  // Relations pour confirmation de paiement (gÃ©nÃ©ration facture PDF Ã  la volÃ©e)
  confirmedQuotePayments    Quote[]    @relation("QuotePaymentReceiver")    // Paiements confirmÃ©s sur devis
  confirmedShipmentPayments Shipment[] @relation("ShipmentPaymentReceiver") // Paiements confirmÃ©s sur colis

  // ğŸ” Access Policies Zenstack

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Chaque user peut lire et modifier son propre profil
  @@allow('read,update', auth().id == id)

  // Les managers peuvent lire les users de leur client
  @@allow('read', auth().clientId == clientId &&
    (auth().role == OPERATIONS_MANAGER || auth().role == FINANCE_MANAGER))

  // Par dÃ©faut, tout est interdit (principe de moindre privilÃ¨ge)
  @@deny('all', true)

  @@index([clientId])
  @@map("user") // Better Auth: nom de table minuscule
}

enum UserRole {
  ADMIN
  OPERATIONS_MANAGER
  FINANCE_MANAGER
  CLIENT
  VIEWER
}

/**
 * Type de client (discriminant pour table Client unifiÃ©e)
 * - COMPANY : Entreprise (B2B) - avec taxId, legalName
 * - INDIVIDUAL : Particulier (B2C) - avec firstName, lastName
 */
enum ClientType {
  COMPANY     // Entreprise
  INDIVIDUAL  // Particulier
}

/**
 * ModÃ¨le Account (OAuth providers + Better Auth)
 * - Compatible avec Better Auth v1.4+ (schÃ©ma officiel)
 * - Chaque user peut gÃ©rer ses propres comptes OAuth
 * - Les admins ont accÃ¨s complet
 */
model Account {
  id                    String    @id @default(cuid())
  accountId             String    // Better Auth: identifiant du compte chez le provider
  providerId            String    // Better Auth: identifiant du provider (google, credential, etc.)
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   // OAuth: access token
  refreshToken          String?   // OAuth: refresh token
  idToken               String?   // OAuth: id token
  accessTokenExpiresAt  DateTime? // OAuth: expiration de l'access token
  refreshTokenExpiresAt DateTime? // OAuth: expiration du refresh token
  scope                 String?   // OAuth: scopes autorisÃ©s
  password              String?   // Better Auth: hashed password for email/password authentication
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // ğŸ” Access Policies
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().id == userId)
  @@deny('all', true)

  @@unique([providerId, accountId]) // Better Auth: contrainte unique sur provider + accountId
  @@index([userId])
  @@map("account") // Better Auth: nom de table minuscule
}

/**
 * ModÃ¨le Session (Better Auth)
 * - Conforme au schÃ©ma Better Auth officiel
 * - Stocke les sessions avec token, IP et user agent
 * - Chaque user peut gÃ©rer ses propres sessions
 * - Les admins ont accÃ¨s complet
 */
model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime // Better Auth: expiresAt au lieu de expires
  token     String   @unique // Better Auth: token au lieu de sessionToken
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  // Better Auth: tracking IP
  userAgent String?  // Better Auth: tracking user agent
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ğŸ” Access Policies
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().id == userId)
  @@deny('all', true)

  @@index([userId])
  @@map("session") // Better Auth: nom de table minuscule
}

/**
 * ModÃ¨le VerificationToken (email verification, password reset)
 * - Accessible en lecture publique (nÃ©cessaire pour la vÃ©rification)
 * - CrÃ©ation/modification rÃ©servÃ©e au systÃ¨me
 */
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  // ğŸ” Access Policies
  @@allow('read', true) // Lecture publique nÃ©cessaire
  @@allow('all', auth().role == ADMIN)
  @@deny('all', true)

  @@unique([identifier, token])
}

/**
 * ModÃ¨le Verification (utilisÃ© par Better Auth)
 * - Pour la vÃ©rification d'email et la rÃ©initialisation de mot de passe
 * - GÃ¨re les tokens avec expiration
 */
model Verification {
  id         String   @id @default(cuid())
  identifier String   // Email ou identifiant de l'utilisateur
  value      String   // Token de vÃ©rification
  expiresAt  DateTime // Date d'expiration du token
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // ğŸ” Access Policies
  @@allow('read', true) // Lecture publique nÃ©cessaire pour Better Auth
  @@allow('all', auth().role == ADMIN)
  @@deny('all', true)

  @@index([identifier])
  @@map("verification")
}

// ============================================
// CLIENTS (Entreprises & Particuliers)
// ============================================

/**
 * ModÃ¨le Client unifiÃ© (Entreprises B2B + Particuliers B2C)
 *
 * Type discriminant : ClientType (COMPANY | INDIVIDUAL)
 * - COMPANY : Entreprise avec taxId, legalName, website
 * - INDIVIDUAL : Particulier avec firstName, lastName
 *
 * Access Control :
 * - ADMIN : accÃ¨s complet Ã  tous les clients
 * - OPERATIONS_MANAGER/FINANCE_MANAGER : lecture de tous les clients
 * - CLIENT/VIEWER : lecture/modification de leur propre client uniquement
 *
 * Workflow crÃ©ation compte :
 * - Particulier s'inscrit â†’ Client INDIVIDUAL crÃ©Ã© automatiquement
 * - Admin crÃ©e user entreprise â†’ Client COMPANY sÃ©lectionnÃ©/crÃ©Ã©
 * - InvitÃ© â†’ Inscription â†’ Rattachement demandes orphelines par email
 */
model Client {
  id         String     @id @default(cuid())

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TYPE DISCRIMINANT (Entreprise ou Particulier)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  type       ClientType @default(INDIVIDUAL)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHAMPS COMMUNS (tous types de clients)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // IdentitÃ©
  name       String     // "Entreprise SARL" OU "Dupont Jean"
  email      String     @unique
  phone      String?

  // Adresse
  address    String
  city       String
  postalCode String?
  country    String     @default("FR")

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHAMPS SPÃ‰CIFIQUES AUX ENTREPRISES (type = COMPANY)
  // NULL pour les particuliers
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  legalName  String?    // Raison sociale (ex: "Acme Corp SARL")
  taxId      String?    @unique // SIRET, TVA intracommunautaire
  website    String?    // Site web de l'entreprise

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHAMPS SPÃ‰CIFIQUES AUX PARTICULIERS (type = INDIVIDUAL)
  // NULL pour les entreprises
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  firstName  String?    // PrÃ©nom du particulier
  lastName   String?    // Nom de famille du particulier

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MÃ‰TADONNÃ‰ES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  users              User[]              // Utilisateurs rattachÃ©s Ã  ce client
  shipments          Shipment[]          // ExpÃ©ditions du client (colis)
  quotes             Quote[]             // Devis du client
  documents          Document[]          // Documents du client
  pickupRequests     PickupRequest[]     // Demandes d'enlÃ¨vement
  purchaseRequests   PurchaseRequest[]   // Demandes d'achat dÃ©lÃ©guÃ©

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ACCESS POLICIES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations et finance managers peuvent lire tous les clients
  @@allow('read', auth().role == OPERATIONS_MANAGER || auth().role == FINANCE_MANAGER)

  // Les users d'un client peuvent lire et modifier leur client
  @@allow('read,update', auth().clientId == id)

  @@deny('all', true)

  @@index([taxId])
  @@index([email])
  @@index([type])
  @@map("Client") // Nom de table en base de donnÃ©es
}

// ============================================
// EXPÃ‰DITIONS
// ============================================

/**
 * ModÃ¨le Shipment (ExpÃ©ditions)
 * - ADMIN : accÃ¨s complet
 * - OPERATIONS_MANAGER : peut crÃ©er, lire, modifier toutes les expÃ©ditions
 * - FINANCE_MANAGER : peut lire toutes les expÃ©ditions
 * - CLIENT : peut lire les expÃ©ditions de son client (COMPANY ou INDIVIDUAL)
 * - Le crÃ©ateur peut modifier tant que status != DELIVERED
 *
 * MODÃˆLE UNIFIÃ‰ :
 * - Toutes les expÃ©ditions appartiennent Ã  un Client (type COMPANY ou INDIVIDUAL)
 * - Plus de logique hybride companyId/userId
 */
model Shipment {
  id             String   @id @default(cuid())
  trackingNumber String   @unique

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CLIENT (Entreprise ou Particulier)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  clientId       String
  client         Client   @relation(fields: [clientId], references: [id])

  // Origine & Destination
  originAddress      String
  originCity         String
  originPostalCode   String
  originCountry      String
  originContact      String?
  originPhone        String?

  destinationAddress    String
  destinationCity       String
  destinationPostalCode String
  destinationCountry    String
  destinationContact    String?
  destinationPhone      String?

  // DÃ©tails marchandise
  cargoType           CargoType
  weight              Float

  // Dimensions (optionnelles) - Volume calculÃ© = L Ã— W Ã— H
  length              Float?            // Longueur en mÃ¨tres
  width               Float?            // Largeur en mÃ¨tres
  height              Float?            // Hauteur en mÃ¨tres

  packageCount        Int
  value               Float?
  currency            String          @default("EUR")
  description         String
  specialInstructions String?

  // Transport
  transportMode TransportMode[]
  priority      Priority        @default(STANDARD)
  isDangerous   Boolean         @default(false)
  isFragile     Boolean         @default(false)

  // Dates
  requestedPickupDate   DateTime?
  actualPickupDate      DateTime?
  estimatedDeliveryDate DateTime?
  actualDeliveryDate    DateTime?

  // Statut
  status ShipmentStatus @default(DRAFT)

  // Financier
  estimatedCost Float?
  actualCost    Float?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PAIEMENT (confirmÃ© par agent)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Date de rÃ©ception du paiement (NULL = pas encore payÃ©)
  // Quand rempli, permet de gÃ©nÃ©rer la facture PDF Ã  la volÃ©e
  // Le paiement peut Ãªtre confirmÃ© Ã  tout moment sur le colis
  paymentReceivedAt    DateTime?
  paymentReceivedById  String?
  paymentReceivedBy    User?    @relation("ShipmentPaymentReceiver", fields: [paymentReceivedById], references: [id])

  // MÃ©tadonnÃ©es
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  trackingEvents TrackingEvent[]
  documents      Document[]
  pickupRequests PickupRequest[]
  fromQuote      Quote?          @relation("QuoteToShipment") // Devis Ã  l'origine de cette expÃ©dition (colis)
  logs           ShipmentLog[]   // Historique complet des Ã©vÃ©nements (changements de statut, etc.)

  // ğŸ” Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent crÃ©er, lire et modifier
  @@allow('create,read,update', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire toutes les expÃ©ditions
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Les clients peuvent lire les expÃ©ditions de leur client (COMPANY ou INDIVIDUAL)
  @@allow('read', auth().clientId == clientId && auth().role == CLIENT)

  // Le crÃ©ateur peut modifier tant que status != DELIVERED
  @@allow('read,update', auth().id == createdById && status != DELIVERED)

  @@deny('all', true)

  @@index([clientId])
  @@index([trackingNumber])
  @@index([status])
  @@index([createdAt])
}

enum CargoType {
  GENERAL
  DANGEROUS
  PERISHABLE
  FRAGILE
  BULK
  CONTAINER
  PALLETIZED
  OTHER
}

enum TransportMode {
  ROAD
  SEA
  AIR
  RAIL
}

enum Priority {
  STANDARD
  EXPRESS
  URGENT
}

enum ShipmentStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PICKED_UP
  IN_TRANSIT
  AT_CUSTOMS
  CUSTOMS_CLEARED
  OUT_FOR_DELIVERY
  READY_FOR_PICKUP  // Disponible au point de retrait
  DELIVERED
  CANCELLED
  ON_HOLD
  EXCEPTION
}

// ============================================
// ENLÃˆVEMENTS (PICKUPS)
// ============================================

/**
 * Statuts simplifiÃ©s pour le workflow Sprint 1
 * Workflow: NOUVEAU â†’ PRISE_EN_CHARGE â†’ EFFECTUE
 * Annulation possible Ã  tout moment: ANNULE (avec raison obligatoire)
 */
enum PickupStatus {
  NOUVEAU         // Demande crÃ©Ã©e, en attente de traitement (24-48h) - US-1.1
  PRISE_EN_CHARGE // Agent Faso Fret a pris en charge la demande - US-3.2
  EFFECTUE        // EnlÃ¨vement rÃ©alisÃ© avec succÃ¨s - US-3.2
  ANNULE          // AnnulÃ© avec raison obligatoire - US-3.3
}

/**
 * CrÃ©neaux horaires pour les enlÃ¨vements
 */
enum PickupTimeSlot {
  MORNING        // Matin (8h-12h)
  AFTERNOON      // AprÃ¨s-midi (12h-17h)
  EVENING        // SoirÃ©e (17h-20h)
  SPECIFIC_TIME  // Heure prÃ©cise (voir pickupTime)
  FLEXIBLE       // Flexible (toute la journÃ©e)
}

/**
 * ModÃ¨le PickupRequest UNIFIÃ‰
 *
 * GÃ¨re Ã  la fois :
 * - Demandes sans compte (US-1.1) : userId = null, accÃ¨s via trackingToken
 * - Demandes avec compte (US-1.4) : userId rempli dÃ¨s la crÃ©ation
 * - Rattachement automatique (US-1.3) : matching par contactEmail/contactPhone
 *
 * Access Control:
 * - Lecture publique via trackingToken (72h) â†’ US-1.2
 * - CrÃ©ation publique â†’ US-1.1
 * - ADMIN/OPERATIONS_MANAGER : accÃ¨s complet â†’ US-3.1, US-3.2, US-3.3
 * - User propriÃ©taire : lecture/modification â†’ US-2.3, US-1.4
 */
model PickupRequest {
  id                 String   @id @default(cuid())

  // ============================================
  // TRACKING ET ACCÃˆS PUBLIC (US-1.1, US-1.2)
  // ============================================

  trackingNumber     String   @unique      // Format: PK-YYYYMMDD-XXXXX
  trackingToken      String   @unique @default(cuid())  // Token unique pour suivi public
  tokenExpiresAt     DateTime              // Token valide 72h (US-1.2)

  // ============================================
  // RATTACHEMENT COMPTE (US-1.3, US-1.4)
  // ============================================

  userId             String?                // Null si non connectÃ©, rempli si connectÃ© ou aprÃ¨s rattachement
  user               User?    @relation("UserPickups", fields: [userId], references: [id])
  isAttachedToAccount Boolean @default(false) // Indique si rattachÃ© Ã  un compte

  // ============================================
  // INFORMATIONS DE CONTACT (pour matching US-1.3)
  // ============================================

  contactEmail       String               // Email de contact (utilisÃ© pour matching)
  contactPhone       String               // TÃ©lÃ©phone de contact (utilisÃ© pour matching)
  contactName        String?              // Nom du contact sur place

  // ============================================
  // ADRESSE D'ENLÃˆVEMENT
  // ============================================

  pickupAddress      String
  pickupCity         String
  pickupPostalCode   String
  pickupCountry      String @default("FR")

  // ============================================
  // PLANIFICATION
  // ============================================

  requestedDate      DateTime              // Date souhaitÃ©e par le client
  scheduledDate      DateTime?             // Date confirmÃ©e par l'agent
  actualPickupDate   DateTime?             // Date/heure rÃ©elle de l'enlÃ¨vement (gardÃ© pour performance)
  timeSlot           PickupTimeSlot @default(FLEXIBLE)
  pickupTime         String?               // Heure prÃ©cise si SPECIFIC_TIME (format "HH:MM")

  // ============================================
  // DÃ‰TAILS MARCHANDISE
  // ============================================

  cargoType          String?               // Type de marchandise (texte libre)
  estimatedWeight    Float?                // Poids estimÃ© en kg
  estimatedVolume    Float?                // Volume estimÃ© en mÂ³
  packageCount       Int?                  // Nombre de colis
  description        String?    @db.Text   // Description dÃ©taillÃ©e

  // ============================================
  // INSTRUCTIONS
  // ============================================

  specialInstructions String?  @db.Text   // Instructions spÃ©ciales (code porte, Ã©tage...)
  accessInstructions  String?  @db.Text   // Instructions d'accÃ¨s (interphone, parking...)
  internalNotes       String?  @db.Text   // Notes internes (visibles uniquement par agents)

  // ============================================
  // WORKFLOW ET STATUT (US-3.2)
  // ============================================

  status             PickupStatus @default(NOUVEAU)

  // ============================================
  // ANNULATION (US-3.3)
  // ============================================

  cancellationReason String?   @db.Text   // Obligatoire si status = ANNULE (validation applicative)

  // ============================================
  // CHAUFFEUR (optionnel, assignÃ© par agent)
  // ============================================

  driverName         String?              // Nom du chauffeur
  driverPhone        String?              // TÃ©lÃ©phone du chauffeur
  vehiclePlate       String?              // Plaque d'immatriculation
  completionNotes    String?   @db.Text   // Notes aprÃ¨s enlÃ¨vement

  // ============================================
  // RELATIONS
  // ============================================

  shipmentId         String?
  shipment           Shipment? @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  documents          Document[]            // Photos, signatures, preuves
  logs               PickupLog[]           // Historique complet des Ã©vÃ©nements (remplace statusHistory)

  // ============================================
  // MÃ‰TADONNÃ‰ES
  // ============================================

  clientId           String?               // Null si non rattachÃ©, sinon client (COMPANY ou INDIVIDUAL) du user
  client             Client?   @relation(fields: [clientId], references: [id])

  createdById        String?               // Null si crÃ©ation publique
  createdBy          User?     @relation("CreatedPickups", fields: [createdById], references: [id])

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // ============================================
  // ğŸ” ACCESS POLICIES
  // ============================================

  // US-1.1 : CrÃ©ation publique (formulaire non connectÃ©)
  // NOTE: La lecture publique via token (US-1.2) est gÃ©rÃ©e par Server Action
  // dÃ©diÃ©e qui utilise le client Prisma standard (non enhanced) car le token
  // n'est pas dans le contexte auth()
  @@allow('create', true)

  // US-3.1, US-3.2, US-3.3 : Admins et operations managers peuvent tout faire
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // US-1.4, US-2.3 : User propriÃ©taire peut lire et modifier ses demandes (sauf si terminÃ©es)
  // NOTE : Zenstack a un problÃ¨me avec cette rÃ¨gle - voir ZENSTACK_ISSUE.md
  // En attendant, le filtrage est fait manuellement dans les Server Actions
  @@allow('read,update', userId != null && auth().id == userId && status != EFFECTUE && status != ANNULE)

  // Les clients peuvent lire les demandes de leur client (COMPANY ou INDIVIDUAL)
  @@allow('read', auth().clientId == clientId && auth().role == CLIENT)

  @@deny('all', true)

  // ============================================
  // INDEXES (optimisation requÃªtes)
  // ============================================

  @@index([trackingNumber])    // Recherche par numÃ©ro (US-3.1)
  @@index([trackingToken])     // AccÃ¨s public (US-1.2)
  @@index([userId])            // Historique user (US-2.3)
  @@index([contactEmail])      // Matching rattachement (US-1.3)
  @@index([contactPhone])      // Matching rattachement (US-1.3)
  @@index([status])            // Filtres back-office (US-3.1)
  @@index([clientId])          // Multi-tenancy (Client COMPANY ou INDIVIDUAL)
  @@index([shipmentId])        // Relations
  @@index([createdAt])         // Tri chronologique
  @@index([status, createdAt]) // Composite pour filtres + tri optimisÃ©

  @@map("pickup_request")
}

/**
 * ModÃ¨le PickupLog (Historique complet des Ã©vÃ©nements)
 *
 * Enregistre TOUS les Ã©vÃ©nements sur une demande d'enlÃ¨vement :
 * - Changements de statut (US-3.2, US-3.4)
 * - Annulations avec raison (US-3.3)
 * - Rattachement Ã  un compte (US-1.3)
 * - Assignation transporteur
 * - Modification de planification
 *
 * UtilisÃ© pour :
 * - Audit trail complet
 * - Temps rÃ©el back-office (US-3.4)
 * - Reconstitution de l'historique
 *
 * Access Control:
 * - ADMIN/OPERATIONS_MANAGER : lecture/Ã©criture complÃ¨te
 * - FINANCE_MANAGER : lecture seule
 * - User propriÃ©taire : lecture des logs de ses demandes
 * - Lecture publique via token (pour suivi transparent)
 */
model PickupLog {
  id        String   @id @default(cuid())

  // Relation avec la demande d'enlÃ¨vement
  pickupId  String
  pickup    PickupRequest @relation(fields: [pickupId], references: [id], onDelete: Cascade)

  // Changement de statut (peut Ãªtre null pour d'autres types d'Ã©vÃ©nements)
  oldStatus PickupStatus?  // Null pour le premier log (crÃ©ation)
  newStatus PickupStatus?  // Null si pas de changement de statut

  // Type d'Ã©vÃ©nement (pour diffÃ©rencier les logs)
  // Valeurs: "CREATED", "STATUS_CHANGED", "ATTACHED_TO_ACCOUNT", "DRIVER_ASSIGNED", etc.
  eventType String

  // Auteur du changement
  changedById String?      // Null si changement automatique (systÃ¨me)
  changedBy   User?   @relation("PickupLogChangedBy", fields: [changedById], references: [id])

  // DÃ©tails du changement
  notes       String? @db.Text  // Raison annulation, commentaire, etc.
  metadata    Json?             // DonnÃ©es additionnelles flexibles (ex: ancien/nouveau transporteur)

  // Horodatage
  createdAt   DateTime @default(now())

  // ğŸ” Access Policies

  // Admins et operations managers peuvent tout faire
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().role == OPERATIONS_MANAGER)

  // Finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // User propriÃ©taire peut lire les logs de ses demandes
  @@allow('read', auth().id == pickup.userId)

  // NOTE: La lecture publique via token est gÃ©rÃ©e par Server Action
  // dÃ©diÃ©e qui utilise le client Prisma standard (non enhanced)

  @@deny('all', true)

  // Indexes pour performance
  @@index([pickupId])           // RÃ©cupÃ©rer l'historique d'une demande
  @@index([createdAt])          // Tri chronologique
  @@index([eventType])          // Filtrer par type d'Ã©vÃ©nement
  @@index([changedById])        // Tracer les actions d'un utilisateur
  @@index([pickupId, createdAt]) // Composite pour historique optimisÃ©

  @@map("pickup_log")
}

// ============================================
// ACHATS DÃ‰LÃ‰GUÃ‰S (PURCHASE REQUESTS)
// ============================================

/**
 * Statuts d'une demande d'achat dÃ©lÃ©guÃ©
 */
enum PurchaseStatus {
  NOUVEAU    // Demande crÃ©Ã©e, en attente de traitement (24-48h)
  EN_COURS   // Faso Fret a pris en charge l'achat
  LIVRE      // Produit achetÃ© et livrÃ© au client
  ANNULE     // AnnulÃ© avec raison obligatoire
}

/**
 * Modes de livraison pour les achats
 */
enum DeliveryMode {
  STANDARD   // Standard (5-7 jours)
  EXPRESS    // Express (2-3 jours, +20% frais)
  URGENT     // Urgent (24-48h, +50% frais)
}

/**
 * ModÃ¨le PurchaseRequest UNIFIÃ‰
 *
 * GÃ¨re Ã  la fois :
 * - Demandes sans compte : userId = null, accÃ¨s via trackingToken
 * - Demandes avec compte : userId rempli dÃ¨s la crÃ©ation
 * - Rattachement automatique : matching par contactEmail/contactPhone
 *
 * Workflow :
 * 1. Client crÃ©e demande (avec ou sans compte)
 * 2. Faso Fret prend en charge (EN_COURS)
 * 3. Achat effectuÃ© et livraison
 * 4. Statut LIVRE avec confirmation
 *
 * Access Control :
 * - Lecture publique via trackingToken (72h)
 * - CrÃ©ation publique (formulaire non connectÃ©)
 * - ADMIN/OPERATIONS_MANAGER : accÃ¨s complet
 * - User propriÃ©taire : lecture/modification
 */
model PurchaseRequest {
  id                 String   @id @default(cuid())

  // ============================================
  // TRACKING ET ACCÃˆS PUBLIC
  // ============================================

  trackingNumber     String   @unique      // Format: PR-YYYYMMDD-XXXXX
  trackingToken      String   @unique @default(cuid())  // Token unique pour suivi public
  tokenExpiresAt     DateTime              // Token valide 72h

  // ============================================
  // RATTACHEMENT COMPTE
  // ============================================

  userId             String?                // Null si non connectÃ©, rempli si connectÃ© ou aprÃ¨s rattachement
  user               User?    @relation("UserPurchases", fields: [userId], references: [id])
  isAttachedToAccount Boolean @default(false) // Indique si rattachÃ© Ã  un compte

  // ============================================
  // INFORMATIONS DE CONTACT (pour matching)
  // ============================================

  contactEmail       String               // Email de contact (utilisÃ© pour matching)
  contactPhone       String               // TÃ©lÃ©phone de contact (utilisÃ© pour matching)
  contactName        String?              // Nom du contact

  // ============================================
  // INFORMATIONS PRODUIT
  // ============================================

  productName        String               // Nom/description du produit Ã  acheter
  productUrl         String?   @db.Text  // URL du produit (si disponible)
  quantity           Int       @default(1) // QuantitÃ© Ã  acheter
  estimatedPrice     Float?               // Prix estimÃ© par le client (â‚¬)
  maxBudget          Float?               // Budget maximum autorisÃ© (â‚¬)
  productDescription String?   @db.Text  // Description dÃ©taillÃ©e du produit

  // ============================================
  // ADRESSE DE LIVRAISON
  // ============================================

  deliveryAddress    String
  deliveryCity       String
  deliveryPostalCode String
  deliveryCountry    String @default("FR")

  // ============================================
  // PLANIFICATION ET LIVRAISON
  // ============================================

  requestedDate      DateTime              // Date de livraison souhaitÃ©e
  deliveryMode       DeliveryMode @default(STANDARD)
  actualDeliveryDate DateTime?             // Date/heure rÃ©elle de livraison

  // ============================================
  // INSTRUCTIONS
  // ============================================

  specialInstructions String?  @db.Text   // Instructions spÃ©ciales (couleur, taille, etc.)
  internalNotes       String?  @db.Text   // Notes internes (visibles uniquement par agents)

  // ============================================
  // WORKFLOW ET STATUT
  // ============================================

  status             PurchaseStatus @default(NOUVEAU)

  // ============================================
  // ANNULATION
  // ============================================

  cancellationReason String?   @db.Text   // Obligatoire si status = ANNULE

  // ============================================
  // COÃ›TS RÃ‰ELS (remplis par agent)
  // ============================================

  actualProductCost  Float?               // CoÃ»t rÃ©el d'achat du produit
  deliveryCost       Float?               // Frais de livraison
  serviceFee         Float?               // Frais de service (15% min 10â‚¬)
  totalCost          Float?               // CoÃ»t total final

  // ============================================
  // PREUVES D'ACHAT
  // ============================================

  purchaseProof      String?   @db.Text   // URL ou rÃ©fÃ©rence de la preuve d'achat
  completionNotes    String?   @db.Text   // Notes aprÃ¨s livraison

  // ============================================
  // CONDITIONS ACCEPTÃ‰ES
  // ============================================

  acceptedTerms      Boolean   @default(false) // Conditions gÃ©nÃ©rales acceptÃ©es
  acceptedUrgentFee  Boolean   @default(false) // Acceptation frais urgence (+20%)
  acceptedPricing    Boolean   @default(false) // Acceptation structure prix (produit + livraison + 15% service)

  // ============================================
  // RELATIONS
  // ============================================

  documents          Document[]            // Preuves d'achat, photos, factures
  logs               PurchaseLog[]         // Historique complet des Ã©vÃ©nements

  // ============================================
  // MÃ‰TADONNÃ‰ES
  // ============================================

  clientId           String?               // Null si non rattachÃ©, sinon client (COMPANY ou INDIVIDUAL) du user
  client             Client?   @relation(fields: [clientId], references: [id])

  createdById        String?               // Null si crÃ©ation publique
  createdBy          User?     @relation("CreatedPurchases", fields: [createdById], references: [id])

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // ============================================
  // ğŸ” ACCESS POLICIES
  // ============================================

  // CrÃ©ation publique (formulaire non connectÃ©)
  @@allow('create', true)

  // Admins et operations managers peuvent tout faire
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // User propriÃ©taire peut lire et modifier ses demandes (sauf si terminÃ©es)
  @@allow('read,update', userId != null && auth().id == userId && status != LIVRE && status != ANNULE)

  // Les clients peuvent lire les demandes de leur client (COMPANY ou INDIVIDUAL)
  @@allow('read', auth().clientId == clientId && auth().role == CLIENT)

  @@deny('all', true)

  // ============================================
  // INDEXES (optimisation requÃªtes)
  // ============================================

  @@index([trackingNumber])    // Recherche par numÃ©ro
  @@index([trackingToken])     // AccÃ¨s public
  @@index([userId])            // Historique user
  @@index([contactEmail])      // Matching rattachement
  @@index([contactPhone])      // Matching rattachement
  @@index([status])            // Filtres back-office
  @@index([clientId])          // Multi-tenancy (Client COMPANY ou INDIVIDUAL)
  @@index([createdAt])         // Tri chronologique
  @@index([status, createdAt]) // Composite pour filtres + tri optimisÃ©

  @@map("purchase_request")
}

/**
 * ModÃ¨le PurchaseLog (Historique complet des Ã©vÃ©nements)
 *
 * Enregistre TOUS les Ã©vÃ©nements sur une demande d'achat :
 * - Changements de statut
 * - Annulations avec raison
 * - Rattachement Ã  un compte
 * - Modifications de prix/budget
 *
 * UtilisÃ© pour :
 * - Audit trail complet
 * - Reconstitution de l'historique
 * - Transparence client
 *
 * Access Control :
 * - ADMIN/OPERATIONS_MANAGER : lecture/Ã©criture complÃ¨te
 * - FINANCE_MANAGER : lecture seule
 * - User propriÃ©taire : lecture des logs de ses demandes
 */
model PurchaseLog {
  id        String   @id @default(cuid())

  // Relation avec la demande d'achat
  purchaseId  String
  purchase    PurchaseRequest @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  // Changement de statut
  oldStatus   PurchaseStatus?  // Null pour le premier log (crÃ©ation)
  newStatus   PurchaseStatus?  // Null si pas de changement de statut

  // Type d'Ã©vÃ©nement
  // Valeurs: "CREATED", "STATUS_CHANGED", "ATTACHED_TO_ACCOUNT", "PRICE_UPDATED", etc.
  eventType   String

  // Auteur du changement
  changedById String?      // Null si changement automatique (systÃ¨me)
  changedBy   User?   @relation("PurchaseLogChangedBy", fields: [changedById], references: [id])

  // DÃ©tails du changement
  notes       String? @db.Text  // Raison annulation, commentaire, etc.
  metadata    Json?             // DonnÃ©es additionnelles flexibles

  // Horodatage
  createdAt   DateTime @default(now())

  // ğŸ” Access Policies

  // Admins et operations managers peuvent tout faire
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().role == OPERATIONS_MANAGER)

  // Finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // User propriÃ©taire peut lire les logs de ses demandes
  @@allow('read', auth().id == purchase.userId)

  @@deny('all', true)

  // Indexes pour performance
  @@index([purchaseId])           // RÃ©cupÃ©rer l'historique d'une demande
  @@index([createdAt])            // Tri chronologique
  @@index([eventType])            // Filtrer par type d'Ã©vÃ©nement
  @@index([changedById])          // Tracer les actions d'un utilisateur
  @@index([purchaseId, createdAt]) // Composite pour historique optimisÃ©

  @@map("purchase_log")
}

// ============================================
// TRACKING
// ============================================

/**
 * ModÃ¨le TrackingEvent (Ã‰vÃ©nements de suivi)
 * - ADMIN/OPERATIONS_MANAGER : peuvent crÃ©er et lire
 * - FINANCE_MANAGER/CLIENT : peuvent lire les events des shipments accessibles
 * - Les tracking events hÃ©ritent des permissions du Shipment parent
 */
model TrackingEvent {
  id          String         @id @default(cuid())
  shipmentId  String
  shipment    Shipment       @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  status      ShipmentStatus
  location    String
  latitude    Float?
  longitude   Float?
  description String?
  timestamp   DateTime       @default(now())
  metadata    Json?

  // Agent qui a effectuÃ© l'action (optionnel pour rÃ©trocompatibilitÃ©)
  performedById String?
  performedBy   User?   @relation("PerformedTrackingEvents", fields: [performedById], references: [id])

  // ğŸ” Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent crÃ©er et lire
  @@allow('create,read', auth().role == OPERATIONS_MANAGER)

  // Lecture publique pour les tracking events (nÃ©cessaire pour tracking public)
  // Les clients peuvent lire les events des shipments de leur client (COMPANY ou INDIVIDUAL)
  @@allow('read', auth().clientId == shipment.clientId)

  @@deny('all', true)

  @@index([shipmentId])
  @@index([timestamp])
}

// ============================================
// HISTORIQUE DES EXPÃ‰DITIONS (SHIPMENT LOG)
// ============================================
//
// Table d'historique pour tracer tous les changements sur les expÃ©ditions.
// Similaire Ã  PickupLog et PurchaseLog, permet de :
// - Suivre les transitions de statut (oldStatus â†’ newStatus)
// - Enregistrer les Ã©vÃ©nements mÃ©tier (crÃ©ation, assignation, paiement, etc.)
// - Garder une trace de qui a fait quoi et quand
//
// Types d'Ã©vÃ©nements :
// - CREATED : CrÃ©ation de l'expÃ©dition
// - STATUS_CHANGED : Changement de statut
// - PAYMENT_RECEIVED : Paiement reÃ§u
// - DOCUMENT_ADDED : Document ajoutÃ©
// - PICKUP_ASSIGNED : EnlÃ¨vement assignÃ©
// - COMMENT_ADDED : Commentaire ajoutÃ©
// ============================================

/**
 * ShipmentLog - Historique des Ã©vÃ©nements sur les expÃ©ditions
 *
 * ğŸ” Access Policies :
 * - Admin : accÃ¨s complet
 * - Operations Manager : crÃ©ation et lecture
 * - Finance Manager : lecture seule (pour audit)
 * - Client : lecture des logs de ses propres expÃ©ditions
 */
model ShipmentLog {
  id        String   @id @default(cuid())

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATION AVEC L'EXPÃ‰DITION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  shipmentId  String
  shipment    Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHANGEMENT DE STATUT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Statut avant le changement (NULL pour le premier log - crÃ©ation)
  oldStatus ShipmentStatus?

  // Statut aprÃ¨s le changement (NULL si pas de changement de statut)
  newStatus ShipmentStatus?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TYPE D'Ã‰VÃ‰NEMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Type d'Ã©vÃ©nement pour diffÃ©rencier les logs
  // Valeurs : "CREATED", "STATUS_CHANGED", "PAYMENT_RECEIVED",
  //           "DOCUMENT_ADDED", "PICKUP_ASSIGNED", "COMMENT_ADDED"
  eventType String

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AUTEUR DU CHANGEMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // ID de l'utilisateur ayant effectuÃ© le changement
  // NULL si changement automatique (systÃ¨me, webhook, etc.)
  changedById String?
  changedBy   User?   @relation("ShipmentLogChangedBy", fields: [changedById], references: [id])

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DÃ‰TAILS DU CHANGEMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Notes ou raison du changement (commentaire agent, explication, etc.)
  notes       String? @db.Text

  // MÃ©tadonnÃ©es flexibles en JSON pour donnÃ©es additionnelles
  // Ex: { "pickupRequestId": "xxx", "documentId": "yyy" }
  metadata    Json?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HORODATAGE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  createdAt   DateTime @default(now())

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ” ACCESS POLICIES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Operations managers peuvent crÃ©er et lire
  @@allow('create,read', auth().role == OPERATIONS_MANAGER)

  // Finance managers peuvent lire (pour audit)
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Le crÃ©ateur de l'expÃ©dition peut lire les logs
  @@allow('read', auth().id == shipment.createdById)

  // Clients peuvent lire les logs des expÃ©ditions de leur entreprise
  @@allow('read', auth().clientId == shipment.clientId && auth().role == CLIENT)

  @@deny('all', true)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INDEXES POUR PERFORMANCE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @@index([shipmentId])
  @@index([eventType])
  @@index([createdAt])
  @@index([changedById])
  @@index([shipmentId, createdAt]) // Composite pour historique optimisÃ©

  @@map("shipment_log")
}

// ============================================
// DEVIS
// ============================================
//
// NOTE: Les factures sont gÃ©nÃ©rÃ©es Ã  la volÃ©e en PDF depuis le devis (Quote)
// lorsque le paiement est confirmÃ© (paymentReceivedAt != null).
// Pas de table Invoice stockÃ©e en base de donnÃ©es.
// ============================================

/**
 * ModÃ¨le Quote (Devis)
 * - ADMIN/OPERATIONS_MANAGER : peuvent crÃ©er et gÃ©rer tous les devis
 * - FINANCE_MANAGER : peut lire tous les devis
 * - CLIENT : peut lire et demander des devis pour sa company
 */
model Quote {
  id                 String          @id @default(cuid())
  quoteNumber        String          @unique

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHAMPS POUR CRÃ‰ATION SANS COMPTE (Pattern PickupRequest)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Token unique pour suivi public (validitÃ© 72h)
  trackingToken      String          @unique @default(cuid())
  tokenExpiresAt     DateTime                              // Expire aprÃ¨s 72h

  // Lien vers l'utilisateur (NULL si crÃ©Ã© sans compte)
  userId             String?
  user               User?           @relation("UserQuotes", fields: [userId], references: [id])

  // Flag indiquant si le devis a Ã©tÃ© rattachÃ© Ã  un compte
  isAttachedToAccount Boolean        @default(false)

  // Informations de contact pour matching lors de l'inscription
  contactEmail       String                                // Email pour matching
  contactPhone       String?                               // TÃ©lÃ©phone pour matching
  contactName        String?                               // Nom du demandeur

  // Client (NULL si crÃ©Ã© sans compte, rempli aprÃ¨s rattachement)
  clientId           String?
  client             Client?         @relation(fields: [clientId], references: [id])

  // Prospect (visiteur sans compte qui a demandÃ© le devis)
  // NULL si crÃ©Ã© par un utilisateur connectÃ©, rempli si crÃ©Ã© via calculateur public
  prospectId         String?
  prospect           Prospect?       @relation(fields: [prospectId], references: [id])

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHAMPS MÃ‰TIER DU DEVIS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  originCountry      String
  destinationCountry String
  transportMode      TransportMode[]
  cargoType          CargoType
  weight             Float

  // Dimensions (optionnelles) - Volume calculÃ© = L Ã— W Ã— H
  // Champs nullable car optionnels dans le formulaire
  length             Float?           // Longueur en mÃ¨tres
  width              Float?           // Largeur en mÃ¨tres
  height             Float?           // Hauteur en mÃ¨tres

  estimatedCost      Float
  validUntil         DateTime
  currency           String          @default("EUR")
  status             QuoteStatus     @default(DRAFT)
  acceptedAt         DateTime?
  rejectedAt         DateTime?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHAMPS WORKFLOW AGENT (Traitement des devis)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // MÃ©thode de paiement choisie par l'agent lors du traitement
  // Valeurs : CASH (Comptant), ON_DELIVERY (Ã€ la livraison), BANK_TRANSFER (Virement)
  paymentMethod        QuotePaymentMethod?

  // Commentaire optionnel de l'agent lors du traitement
  agentComment         String?

  // Date de dÃ©but du traitement (passage Ã  IN_TREATMENT)
  treatmentStartedAt   DateTime?

  // Date de validation du traitement (passage Ã  VALIDATED)
  treatmentValidatedAt DateTime?

  // ID de l'agent qui a traitÃ© le devis
  treatmentAgentId     String?
  treatmentAgent       User?           @relation("QuoteTreatmentAgent", fields: [treatmentAgentId], references: [id])

  // Date d'annulation et raison (si statut CANCELLED)
  cancelledAt          DateTime?
  cancelReason         String?

  // Relation vers l'expÃ©dition crÃ©Ã©e lors de la validation
  shipmentId           String?         @unique
  shipment             Shipment?       @relation("QuoteToShipment", fields: [shipmentId], references: [id])

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PAIEMENT (confirmÃ© par agent)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Date de rÃ©ception du paiement (NULL = pas encore payÃ©)
  // Quand rempli, permet de gÃ©nÃ©rer la facture PDF Ã  la volÃ©e
  paymentReceivedAt    DateTime?
  paymentReceivedById  String?
  paymentReceivedBy    User?           @relation("QuotePaymentReceiver", fields: [paymentReceivedById], references: [id])

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // ID de l'utilisateur qui a crÃ©Ã© le devis (NULL si crÃ©Ã© sans compte)
  createdById        String?
  createdBy          User?           @relation("CreatedQuotes", fields: [createdById], references: [id])

  documents          Document[]
  logs               QuoteLog[]      // Historique complet des Ã©vÃ©nements (changements de statut, etc.)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // ğŸ” Access Policies

  // CrÃ©ation publique autorisÃ©e (formulaire sans connexion)
  // Note: Le suivi par token est gÃ©rÃ© hors Zenstack (client prisma standard)
  @@allow('create', true)

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent crÃ©er, lire et modifier
  @@allow('create,read,update', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Les clients peuvent lire et crÃ©er des quotes pour leur client (COMPANY ou INDIVIDUAL)
  @@allow('read,create', clientId != null && auth().clientId == clientId && auth().role == CLIENT)

  // Le propriÃ©taire peut lire et modifier son devis (si rattachÃ© Ã  un compte)
  @@allow('read,update', userId != null && auth().id == userId)

  @@deny('all', true)

  @@index([clientId])
  @@index([prospectId])
  @@index([status])
  @@index([trackingToken])
  @@index([contactEmail])
  @@index([userId])
}

enum QuoteStatus {
  DRAFT          // Brouillon - devis en cours de crÃ©ation
  SENT           // EnvoyÃ© - devis envoyÃ© au client, en attente de rÃ©ponse
  ACCEPTED       // AcceptÃ© - le client a acceptÃ© le devis
  REJECTED       // RejetÃ© - le client a refusÃ© le devis
  EXPIRED        // ExpirÃ© - date de validitÃ© dÃ©passÃ©e
  IN_TREATMENT   // En traitement - un agent traite le devis (aprÃ¨s acceptation client)
  VALIDATED      // ValidÃ© - traitement terminÃ© par l'agent, colis crÃ©Ã©
  CANCELLED      // AnnulÃ© - devis annulÃ© par l'agent
}

/**
 * MÃ©thode de paiement choisie lors du traitement d'un devis
 * UtilisÃ© par l'agent lors du workflow de traitement
 */
enum QuotePaymentMethod {
  CASH           // Comptant - paiement immÃ©diat
  ON_DELIVERY    // Ã€ la livraison - paiement Ã  la rÃ©ception
  BANK_TRANSFER  // Virement bancaire - envoi du RIB au client
}

/**
 * Journal des Ã©vÃ©nements sur les devis
 *
 * Trace l'historique complet des changements de statut et Ã©vÃ©nements
 * sur les devis : crÃ©ation, envoi, acceptation, traitement, validation, etc.
 *
 * Pattern identique Ã  PickupLog et PurchaseLog pour cohÃ©rence.
 *
 * Types d'Ã©vÃ©nements (eventType) :
 * - CREATED : CrÃ©ation initiale du devis
 * - STATUS_CHANGED : Changement de statut (DRAFT â†’ SENT â†’ ACCEPTED, etc.)
 * - ATTACHED_TO_ACCOUNT : Rattachement Ã  un compte utilisateur
 * - TREATMENT_STARTED : DÃ©but du traitement par un agent
 * - TREATMENT_VALIDATED : Validation du traitement (crÃ©ation expÃ©dition)
 * - PAYMENT_RECEIVED : Paiement reÃ§u
 * - CANCELLED : Annulation du devis
 * - COMMENT_ADDED : Ajout d'un commentaire
 */
model QuoteLog {
  id        String   @id @default(cuid())

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RELATION AVEC LE DEVIS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  quoteId   String
  quote     Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHANGEMENT DE STATUT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Statut avant le changement (NULL pour le premier log - crÃ©ation)
  oldStatus QuoteStatus?

  // Statut aprÃ¨s le changement (NULL si pas de changement de statut)
  newStatus QuoteStatus?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TYPE D'Ã‰VÃ‰NEMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Type d'Ã©vÃ©nement pour diffÃ©rencier les logs
  // Valeurs : "CREATED", "STATUS_CHANGED", "ATTACHED_TO_ACCOUNT",
  //           "TREATMENT_STARTED", "TREATMENT_VALIDATED", "PAYMENT_RECEIVED",
  //           "CANCELLED", "COMMENT_ADDED"
  eventType String

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AUTEUR DU CHANGEMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // ID de l'utilisateur ayant effectuÃ© le changement
  // NULL si changement automatique (systÃ¨me, expiration, etc.)
  changedById String?
  changedBy   User?   @relation("QuoteLogChangedBy", fields: [changedById], references: [id])

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DÃ‰TAILS DU CHANGEMENT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Notes ou raison du changement (raison d'annulation, commentaire agent, etc.)
  notes       String? @db.Text

  // MÃ©tadonnÃ©es flexibles en JSON pour donnÃ©es additionnelles
  // Ex: { "paymentMethod": "CASH", "shipmentId": "xxx" }
  metadata    Json?

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HORODATAGE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  createdAt   DateTime @default(now())

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ” ACCESS POLICIES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Operations managers peuvent tout faire (ils gÃ¨rent les devis)
  @@allow('all', auth().role == OPERATIONS_MANAGER)

  // Finance managers peuvent lire (pour audit)
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Le propriÃ©taire du devis peut lire les logs de ses devis
  @@allow('read', auth().id == quote.userId)

  // Clients peuvent lire les logs des devis de leur entreprise
  @@allow('read', quote.clientId != null && auth().clientId == quote.clientId && auth().role == CLIENT)

  // Note: La lecture publique via token est gÃ©rÃ©e par Server Action
  // dÃ©diÃ©e qui utilise le client Prisma standard (non enhanced)

  @@deny('all', true)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INDEXES POUR PERFORMANCE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @@index([quoteId])
  @@index([eventType])
  @@index([createdAt])
  @@index([changedById])
  @@index([quoteId, createdAt]) // Composite pour historique optimisÃ©

  @@map("quote_log")
}

enum ProspectStatus {
  PENDING      // En attente de finalisation d'inscription
  CONVERTED    // Converti en User
  EXPIRED      // Token d'invitation expirÃ©
}

// ============================================
// PROSPECTS (visiteurs sans compte)
// ============================================

/**
 * ModÃ¨le Prospect
 * ReprÃ©sente une personne qui a demandÃ© un devis sans crÃ©er de compte complet
 *
 * Workflow :
 * 1. Utilisateur non-connectÃ© demande un devis â†’ CrÃ©ation Prospect + Quote (avec prospectId)
 * 2. Email envoyÃ© avec PDF + lien invitation (token valide 7 jours)
 * 3. Prospect clique sur le lien â†’ Finalise inscription â†’ Conversion en User
 * 4. Quotes rattachÃ©s au Client du User (clientId rempli, isAttachedToAccount = true)
 *
 * Access policies :
 * - Lecture publique (pour vÃ©rification du token)
 * - CrÃ©ation publique (calculateur accessible Ã  tous)
 * - Modification/suppression rÃ©servÃ©e aux ADMIN
 */
model Prospect {
  id                    String         @id @default(cuid())
  email                 String         @unique
  phone                 String?
  name                  String?
  company               String?        // Nom entreprise (texte libre, pas liÃ© Ã  Company)
  subject               String?        // Objet de la demande de contact

  // Token d'invitation sÃ©curisÃ©
  invitationToken       String         @unique @default(cuid())
  invitationExpiresAt   DateTime       // 7 jours aprÃ¨s crÃ©ation

  status                ProspectStatus @default(PENDING)

  // Lien vers User si converti
  userId                String?        @unique
  user                  User?          @relation(fields: [userId], references: [id])

  // Devis crÃ©Ã©s par ce prospect (avant crÃ©ation de compte)
  quotes                Quote[]

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  // ğŸ” Access Policies

  // Lecture publique nÃ©cessaire pour vÃ©rifier les tokens
  @@allow('read', true)

  // CrÃ©ation publique pour le calculateur de devis
  @@allow('create', true)

  // Seuls les admins peuvent modifier ou supprimer
  @@allow('update,delete', auth().role == ADMIN)

  // Par dÃ©faut, tout est interdit
  @@deny('all', true)

  @@index([email])
  @@index([invitationToken])
  @@index([status])
}

// ============================================
// NOTIFICATIONS
// ============================================

/**
 * ModÃ¨le Notification (Notifications utilisateur)
 * - ADMIN : peut lire et crÃ©er toutes les notifications
 * - Chaque user peut lire et modifier ses propres notifications
 */
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  // ğŸ” Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Chaque user peut lire et modifier (marquer comme lu) ses propres notifications
  @@allow('read,update', auth().id == userId)

  // Les operations managers peuvent crÃ©er des notifications
  @@allow('create', auth().role == OPERATIONS_MANAGER)

  @@deny('all', true)

  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  SHIPMENT_CREATED
  SHIPMENT_PICKED_UP
  SHIPMENT_IN_TRANSIT
  SHIPMENT_DELIVERED
  SHIPMENT_DELAYED
  INVOICE_GENERATED
  INVOICE_PAID
  QUOTE_REQUEST
  CUSTOMS_CLEARED
  DOCUMENT_UPLOADED
}

// ============================================
// GESTION DOCUMENTAIRE
// ============================================

/**
 * Type de document
 */
enum DocumentType {
  INVOICE_SCAN           // Scan de facture
  PROOF_OF_DELIVERY      // Preuve de livraison
  PROOF_OF_PICKUP        // Preuve d'enlÃ¨vement
  PICKUP_SIGNATURE       // Signature d'enlÃ¨vement
  CUSTOMS_DOCUMENT       // Document douanier
  PACKING_LIST           // Liste de colisage
  BILL_OF_LADING         // Connaissement
  CMR                    // Lettre de voiture CMR
  AIRWAY_BILL            // Lettre de transport aÃ©rien
  CERTIFICATE            // Certificat (origine, conformitÃ©, etc.)
  PHOTO                  // Photo de la marchandise
  OTHER                  // Autre document
}

/**
 * ModÃ¨le Document (Gestion documentaire)
 * - ADMIN : accÃ¨s complet Ã  tous les documents
 * - OPERATIONS_MANAGER : peut crÃ©er, lire et supprimer tous les documents
 * - FINANCE_MANAGER : peut lire tous les documents
 * - CLIENT : peut crÃ©er et lire les documents de sa company
 * - PARTICULIER : peut crÃ©er et lire ses propres documents (via userId direct)
 * - L'uploader peut supprimer son propre document
 *
 * PROPRIÃ‰TÃ‰ HYBRIDE :
 * - Si companyId != null : le document appartient Ã  la company
 * - Si companyId == null : le document appartient directement au userId
 */
model Document {
  id          String       @id @default(cuid())
  name        String       // Nom du fichier original
  fileUrl     String       // URL du fichier stockÃ© (UploadThing, S3, etc.)
  fileKey     String       // ClÃ© unique du fichier pour suppression
  fileSize    Int          // Taille en octets
  mimeType    String       // Type MIME (application/pdf, image/jpeg, etc.)
  type        DocumentType // Type de document
  description String?      // Description optionnelle

  // Relations (au moins une doit Ãªtre prÃ©sente)
  shipmentId String?
  shipment   Shipment? @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  quoteId String?
  quote   Quote?    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  pickupRequestId String?
  pickupRequest   PickupRequest? @relation(fields: [pickupRequestId], references: [id], onDelete: Cascade)

  purchaseRequestId String?
  purchaseRequest   PurchaseRequest? @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CLIENT (Entreprise ou Particulier)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Client (COMPANY ou INDIVIDUAL) auquel appartient le document
  clientId    String?
  client      Client?   @relation(fields: [clientId], references: [id])

  // PropriÃ©taire direct (utilisateur qui possÃ¨de ce document)
  userId      String?
  user        User?     @relation("UserDocuments", fields: [userId], references: [id])

  // Uploader du document (peut Ãªtre diffÃ©rent du propriÃ©taire)
  uploadedBy  String
  uploader    User     @relation("UploadedDocuments", fields: [uploadedBy], references: [id])
  uploadedAt  DateTime @default(now())

  // ğŸ” Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent crÃ©er, lire et supprimer
  @@allow('create,read,delete', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire tous les documents
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Les clients peuvent crÃ©er et lire les documents de leur client (COMPANY ou INDIVIDUAL)
  @@allow('create,read', clientId != null && auth().clientId == clientId && auth().role == CLIENT)

  // Le propriÃ©taire direct peut crÃ©er et lire ses documents
  @@allow('create,read', userId != null && auth().id == userId)

  // L'uploader peut supprimer son propre document
  @@allow('delete', auth().id == uploadedBy)

  @@deny('all', true)

  @@index([clientId])
  @@index([userId])
  @@index([shipmentId])
  @@index([quoteId])
  @@index([pickupRequestId])
  @@index([purchaseRequestId])
  @@index([uploadedBy])
}

// ============================================
// TRANSPORTEURS
// ============================================

// ============================================
// CONFIGURATION DES PRIX
// ============================================

/**
 * ModÃ¨le PricingConfig (Configuration globale des prix)
 *
 * Stocke tous les paramÃ¨tres de tarification utilisÃ©s dans le calcul des devis.
 * Il ne doit exister qu'une seule instance de ce modÃ¨le (singleton).
 *
 * Structure des champs JSON :
 * - transportMultipliers : { ROAD: 1.0, SEA: 0.6, AIR: 3.0, RAIL: 0.8 }
 * - cargoTypeSurcharges : { GENERAL: 0, DANGEROUS: 0.5, PERISHABLE: 0.4, ... }
 * - prioritySurcharges : { STANDARD: 0, NORMAL: 0.1, EXPRESS: 0.5, URGENT: 0.3 }
 * - deliverySpeedsPerMode : {
 *     ROAD: { min: 3, max: 7 },
 *     SEA: { min: 20, max: 45 },
 *     AIR: { min: 1, max: 3 },
 *     RAIL: { min: 7, max: 14 }
 *   }
 * - volumetricWeightRatios : { AIR: 167, ROAD: 333, SEA: 1, RAIL: 250 }
 *   â†’ DÃ©finit combien de kg Ã©quivaut 1 mÂ³ pour chaque mode
 *   â†’ BasÃ© sur les ratios du PDF : AIR (1/6 = 6000), ROAD (1/3 = 5000), SEA (1/1 = 1000)
 * - useVolumetricWeightPerMode : { AIR: true, ROAD: true, SEA: false, RAIL: true }
 *   â†’ Active/dÃ©sactive le poids volumÃ©trique par mode
 *   â†’ Maritime (SEA) utilise "Poids ou Mesure" (UnitÃ© Payante) au lieu du poids volumÃ©trique
 *
 * Access policies :
 * - ADMIN uniquement pour toutes les opÃ©rations
 */
model PricingConfig {
  id                   String   @id @default(cuid())

  // Taux de base
  baseRatePerKg        Float    @default(0.5) // â‚¬ par kg (ANCIEN - conservÃ© pour compatibilitÃ©)

  // NOUVEAUX : Tarifs par dÃ©faut pour fallback (si route non configurÃ©e dans matrice)
  defaultRatePerKg     Float    @default(1.0)   // â‚¬ par kg
  defaultRatePerM3     Float    @default(200.0) // â‚¬ par mÂ³

  // Multiplicateurs par mode de transport (utilisÃ©s uniquement si route non configurÃ©e)
  transportMultipliers Json     // { ROAD: Float, SEA: Float, AIR: Float, RAIL: Float }

  // Surcharges par type de cargo (coefficients multiplicateurs, ex: DANGEROUS: 0.5 = +50%)
  cargoTypeSurcharges  Json     // { GENERAL: Float, DANGEROUS: Float, PERISHABLE: Float, ... }

  // Surcharges par prioritÃ© (coefficients multiplicateurs, ex: NORMAL: 0.1 = +10%)
  prioritySurcharges   Json     // { STANDARD: Float, NORMAL: Float, EXPRESS: Float, URGENT: Float }

  // DÃ©lais de livraison par mode (en jours)
  deliverySpeedsPerMode Json    // { ROAD: {min, max}, SEA: {min, max}, ... }

  // === NOUVEAUX CHAMPS POUR ALGORITHME PDF ===

  // Ratios de conversion poids volumÃ©trique : combien de kg = 1 mÂ³
  // Exemple : { AIR: 167, ROAD: 333, SEA: 1, RAIL: 250 }
  // AIR: 167 signifie que 1 mÂ³ = 167 kg (ratio 1/6 = 6000)
  // ROAD: 333 signifie que 1 mÂ³ = 333 kg (ratio 1/3 = 5000)
  // SEA: 1 signifie que 1 mÂ³ = 1 tonne (ratio 1/1 = 1000)
  volumetricWeightRatios Json @default("{\"AIR\":167,\"ROAD\":333,\"SEA\":1,\"RAIL\":250}")

  // Activation du poids volumÃ©trique par mode de transport
  // Exemple : { AIR: true, ROAD: true, SEA: false, RAIL: true }
  // SEA: false car le maritime utilise "Poids ou Mesure" (UnitÃ© Payante)
  useVolumetricWeightPerMode Json @default("{\"AIR\":true,\"ROAD\":true,\"SEA\":false,\"RAIL\":true}")

  // MÃ©tadonnÃ©es
  updatedById          String
  updatedBy            User     @relation(fields: [updatedById], references: [id])
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // ğŸ” Access Policies

  // Seuls les admins peuvent gÃ©rer la configuration des prix
  @@allow('all', auth().role == ADMIN)

  @@deny('all', true)

  @@map("pricing_config")
}

/**
 * ModÃ¨le CountryDistance (Distances entre pays)
 *
 * Table de rÃ©fÃ©rence des distances en kilomÃ¨tres entre les pays.
 * UtilisÃ©e dans le calcul du facteur de distance pour les devis.
 *
 * Contraintes :
 * - Chaque paire (originCountry, destinationCountry) doit Ãªtre unique
 * - Les distances sont bidirectionnelles (FR->DE = DE->FR)
 *
 * Access policies :
 * - Lecture publique (nÃ©cessaire pour le calcul des devis publics)
 * - CrÃ©ation/Modification/Suppression : ADMIN uniquement
 */
model CountryDistance {
  id                 String   @id @default(cuid())
  originCountry      String   // Code pays ISO (ex: "FR", "DE", "ES")
  destinationCountry String   // Code pays ISO
  distanceKm         Int      // Distance en kilomÃ¨tres

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // ğŸ” Access Policies

  // Lecture publique nÃ©cessaire pour calcul des devis
  @@allow('read', true)

  // Seuls les admins peuvent crÃ©er, modifier ou supprimer
  @@allow('create,update,delete', auth().role == ADMIN)

  @@deny('all', true)

  @@unique([originCountry, destinationCountry])
  @@index([originCountry])
  @@index([destinationCountry])
  @@map("country_distance")
}

/**
 * ModÃ¨le TransportRate (Tarifs de Transport par Route)
 *
 * Stocke les tarifs spÃ©cifiques pour chaque combinaison origine-destination-mode.
 * Permet une tarification granulaire avec des surcharges personnalisÃ©es par route.
 *
 * Structure :
 * - ClÃ© unique : (originCountryCode, destinationCountryCode, transportMode)
 * - Tarifs : ratePerKg (â‚¬/kg) et ratePerM3 (â‚¬/mÂ³)
 * - Surcharges optionnelles : JSON pour cargo et prioritÃ©
 *
 * Logique de calcul :
 * 1. prixBase = MAX(poids Ã— ratePerKg, volume Ã— ratePerM3)
 * 2. Appliquer surcharges cargo de la route (ou fallback PricingConfig)
 * 3. Appliquer surcharges prioritÃ© de la route (ou fallback PricingConfig)
 *
 * Access policies :
 * - Lecture publique (nÃ©cessaire pour calcul des devis publics)
 * - CrÃ©ation/Modification/Suppression : ADMIN uniquement
 */
model TransportRate {
  id                     String        @id @default(cuid())

  // ClÃ© de route
  originCountryCode      String        // Code pays ISO (ex: "FR")
  destinationCountryCode String        // Code pays ISO (ex: "BF")
  transportMode          TransportMode // ROAD | SEA | AIR | RAIL

  // Tarifs de base (requis)
  ratePerKg              Float         // Tarif en â‚¬/kg
  ratePerM3              Float         // Tarif en â‚¬/mÂ³

  // Surcharges personnalisÃ©es (optionnelles, JSON)
  // Si null, utilise les surcharges globales de PricingConfig
  cargoTypeSurcharges    Json?         // { GENERAL: 0, DANGEROUS: 0.3, ... }
  prioritySurcharges     Json?         // { STANDARD: 0, EXPRESS: 0.5, ... }

  // MÃ©tadonnÃ©es
  isActive               Boolean       @default(true) // Permet de dÃ©sactiver une route
  notes                  String?       // Notes internes
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // ğŸ” Access Policies

  // Lecture publique nÃ©cessaire pour calcul des devis
  @@allow('read', true)

  // Seuls les admins peuvent crÃ©er, modifier ou supprimer
  @@allow('all', auth().role == ADMIN)

  // Index et contraintes
  @@unique([originCountryCode, destinationCountryCode, transportMode])
  @@index([originCountryCode])
  @@index([destinationCountryCode])
  @@index([transportMode])
  @@index([isActive])
  @@map("transport_rate")
}

// ============================================
// GESTION DES PAYS
// ============================================

/**
 * ModÃ¨le Country (Pays)
 *
 * Table de rÃ©fÃ©rence des pays disponibles pour les expÃ©ditions.
 * UtilisÃ©e pour les sÃ©lecteurs de pays d'origine et de destination.
 *
 * Structure :
 * - code : Code ISO 3166-1 alpha-2 (ex: "FR", "DE", "US")
 * - name : Nom du pays en franÃ§ais (ex: "France", "Allemagne", "Ã‰tats-Unis")
 * - isActive : Indique si le pays est actif pour les expÃ©ditions
 *
 * Access policies :
 * - Lecture publique (nÃ©cessaire pour les formulaires de devis publics)
 * - CrÃ©ation/Modification/Suppression : ADMIN uniquement
 */
model Country {
  id        String   @id @default(cuid())
  code      String   @unique // Code ISO 3166-1 alpha-2 (ex: "FR", "DE")
  name      String   // Nom en franÃ§ais (ex: "France", "Allemagne")
  isActive  Boolean  @default(true) // Pays activÃ© pour les expÃ©ditions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ğŸ” Access Policies

  // Lecture publique nÃ©cessaire pour les formulaires de devis
  @@allow('read', true)

  // Seuls les admins peuvent crÃ©er, modifier ou supprimer
  @@allow('create,update,delete', auth().role == ADMIN)

  // Par dÃ©faut, refuser ce qui n'est pas explicitement autorisÃ©
  // Note: Ne pas utiliser @@deny('all', true) car cela bloquerait mÃªme les @@allow ci-dessus
  @@deny('all', auth() == null)

  @@index([code])
  @@index([isActive])
  @@map("country")
}
