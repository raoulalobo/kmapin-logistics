// Sch√©ma Zenstack - KmapIn Logistics
// Application de gestion de fret multi-modal avec Access Control

/**
 * Generator Prisma standard
 * G√©n√®re les binaires pour Linux (Vercel) et le syst√®me local
 */
generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

/**
 * Plugin Zenstack pour hooks React Query
 */
plugin hooks {
  provider = '@zenstackhq/tanstack-query'
  target = 'react'
  version = 'v5'
  output = "../src/lib/hooks"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTIFICATION (Better Auth)
// ============================================

/**
 * Mod√®le User avec access control
 * - ADMIN : acc√®s complet √† tous les users
 * - OPERATIONS_MANAGER/FINANCE_MANAGER : peuvent lire les users de leur entreprise
 * - CLIENT/VIEWER : peuvent lire uniquement leur propre profil
 * - Tous les users peuvent modifier leur propre profil
 */
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified Boolean   @default(false) // Better Auth: Boolean au lieu de DateTime
  name          String?
  image         String?
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations Better Auth
  accounts Account[]
  sessions Session[]

  // Champs business
  role        UserRole @default(CLIENT)
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id])
  permissions Json?

  // Relations
  createdShipments   Shipment[] @relation("CreatedBy")
  createdInvoices    Invoice[]  @relation("CreatedBy")
  uploadedDocuments  Document[] @relation("UploadedDocuments")
  prospect           Prospect?  // Relation 1:1 avec Prospect (si converti)
  pricingConfigs     PricingConfig[] // Configurations de prix modifi√©es par cet utilisateur
  createdPickups     PickupRequest[] @relation("CreatedPickups") // Demandes d'enl√®vement cr√©√©es

  // üîê Access Policies Zenstack

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Chaque user peut lire et modifier son propre profil
  @@allow('read,update', auth() == this)

  // Les managers peuvent lire les users de leur entreprise
  @@allow('read', auth().companyId == companyId &&
    (auth().role == OPERATIONS_MANAGER || auth().role == FINANCE_MANAGER))

  // Par d√©faut, tout est interdit (principe de moindre privil√®ge)
  @@deny('all', true)

  @@index([companyId])
  @@map("user") // Better Auth: nom de table minuscule
}

enum UserRole {
  ADMIN
  OPERATIONS_MANAGER
  FINANCE_MANAGER
  CLIENT
  VIEWER
}

/**
 * Mod√®le Account (OAuth providers + Better Auth)
 * - Compatible avec Better Auth v1.4+ (sch√©ma officiel)
 * - Chaque user peut g√©rer ses propres comptes OAuth
 * - Les admins ont acc√®s complet
 */
model Account {
  id                    String    @id @default(cuid())
  accountId             String    // Better Auth: identifiant du compte chez le provider
  providerId            String    // Better Auth: identifiant du provider (google, credential, etc.)
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   // OAuth: access token
  refreshToken          String?   // OAuth: refresh token
  idToken               String?   // OAuth: id token
  accessTokenExpiresAt  DateTime? // OAuth: expiration de l'access token
  refreshTokenExpiresAt DateTime? // OAuth: expiration du refresh token
  scope                 String?   // OAuth: scopes autoris√©s
  password              String?   // Better Auth: hashed password for email/password authentication
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // üîê Access Policies
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().id == userId)
  @@deny('all', true)

  @@unique([providerId, accountId]) // Better Auth: contrainte unique sur provider + accountId
  @@index([userId])
  @@map("account") // Better Auth: nom de table minuscule
}

/**
 * Mod√®le Session (Better Auth)
 * - Conforme au sch√©ma Better Auth officiel
 * - Stocke les sessions avec token, IP et user agent
 * - Chaque user peut g√©rer ses propres sessions
 * - Les admins ont acc√®s complet
 */
model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime // Better Auth: expiresAt au lieu de expires
  token     String   @unique // Better Auth: token au lieu de sessionToken
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  // Better Auth: tracking IP
  userAgent String?  // Better Auth: tracking user agent
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // üîê Access Policies
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().id == userId)
  @@deny('all', true)

  @@index([userId])
  @@map("session") // Better Auth: nom de table minuscule
}

/**
 * Mod√®le VerificationToken (email verification, password reset)
 * - Accessible en lecture publique (n√©cessaire pour la v√©rification)
 * - Cr√©ation/modification r√©serv√©e au syst√®me
 */
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  // üîê Access Policies
  @@allow('read', true) // Lecture publique n√©cessaire
  @@allow('all', auth().role == ADMIN)
  @@deny('all', true)

  @@unique([identifier, token])
}

/**
 * Mod√®le Verification (utilis√© par Better Auth)
 * - Pour la v√©rification d'email et la r√©initialisation de mot de passe
 * - G√®re les tokens avec expiration
 */
model Verification {
  id         String   @id @default(cuid())
  identifier String   // Email ou identifiant de l'utilisateur
  value      String   // Token de v√©rification
  expiresAt  DateTime // Date d'expiration du token
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // üîê Access Policies
  @@allow('read', true) // Lecture publique n√©cessaire pour Better Auth
  @@allow('all', auth().role == ADMIN)
  @@deny('all', true)

  @@index([identifier])
  @@map("verification")
}

// ============================================
// ENTREPRISES & CLIENTS
// ============================================

/**
 * Mod√®le Company (Entreprises/Clients)
 * - ADMIN : acc√®s complet
 * - OPERATIONS_MANAGER/FINANCE_MANAGER : peuvent voir toutes les companies
 * - CLIENT/VIEWER : peuvent voir uniquement leur propre company
 * - Les users d'une company peuvent modifier certains champs de leur company
 */
model Company {
  id         String   @id @default(cuid())
  name       String
  legalName  String?
  taxId      String?  @unique
  email      String
  phone      String?
  address    String
  city       String
  postalCode String?
  country    String
  website    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  users          User[]
  shipments      Shipment[]
  invoices       Invoice[]
  quotes         Quote[]
  documents      Document[]
  transporters   Transporter[]
  pickupRequests PickupRequest[] // Demandes d'enl√®vement de cette company

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations et finance managers peuvent lire toutes les companies
  @@allow('read', auth().role == OPERATIONS_MANAGER || auth().role == FINANCE_MANAGER)

  // Les users d'une company peuvent lire et modifier leur company
  @@allow('read,update', auth().companyId == id)

  @@deny('all', true)

  @@index([taxId])
}

// ============================================
// EXP√âDITIONS
// ============================================

/**
 * Mod√®le Shipment (Exp√©ditions)
 * - ADMIN : acc√®s complet
 * - OPERATIONS_MANAGER : peut cr√©er, lire, modifier toutes les exp√©ditions
 * - FINANCE_MANAGER : peut lire toutes les exp√©ditions
 * - CLIENT : peut lire uniquement les exp√©ditions de sa company
 * - Le cr√©ateur peut modifier tant que status != DELIVERED
 */
model Shipment {
  id             String   @id @default(cuid())
  trackingNumber String   @unique
  companyId      String
  company        Company  @relation(fields: [companyId], references: [id])

  // Origine & Destination
  originAddress      String
  originCity         String
  originPostalCode   String
  originCountry      String
  originContact      String?
  originPhone        String?

  destinationAddress    String
  destinationCity       String
  destinationPostalCode String
  destinationCountry    String
  destinationContact    String?
  destinationPhone      String?

  // D√©tails marchandise
  cargoType           CargoType
  weight              Float

  // Dimensions (optionnelles) - Volume calcul√© = L √ó W √ó H
  length              Float?            // Longueur en m√®tres
  width               Float?            // Largeur en m√®tres
  height              Float?            // Hauteur en m√®tres

  packageCount        Int
  value               Float?
  currency            String          @default("EUR")
  description         String
  specialInstructions String?

  // Transport
  transportMode TransportMode[]
  priority      Priority        @default(STANDARD)
  isDangerous   Boolean         @default(false)
  isFragile     Boolean         @default(false)

  // Dates
  requestedPickupDate   DateTime?
  actualPickupDate      DateTime?
  estimatedDeliveryDate DateTime?
  actualDeliveryDate    DateTime?

  // Statut
  status ShipmentStatus @default(DRAFT)

  // Financier
  estimatedCost Float?
  actualCost    Float?
  invoiceId     String?  @unique
  invoice       Invoice? @relation(fields: [invoiceId], references: [id])

  // M√©tadonn√©es
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  trackingEvents TrackingEvent[]
  documents      Document[]
  pickupRequests PickupRequest[]

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent cr√©er, lire et modifier
  @@allow('create,read,update', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire toutes les exp√©ditions
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Les clients peuvent lire les exp√©ditions de leur company
  @@allow('read', auth().companyId == companyId && auth().role == CLIENT)

  // Le cr√©ateur peut modifier tant que status != DELIVERED
  @@allow('read,update', auth().id == createdById && status != DELIVERED)

  @@deny('all', true)

  @@index([companyId])
  @@index([trackingNumber])
  @@index([status])
  @@index([createdAt])
}

enum CargoType {
  GENERAL
  DANGEROUS
  PERISHABLE
  FRAGILE
  BULK
  CONTAINER
  PALLETIZED
  OTHER
}

enum TransportMode {
  ROAD
  SEA
  AIR
  RAIL
}

enum Priority {
  STANDARD
  EXPRESS
  URGENT
}

enum ShipmentStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PICKED_UP
  IN_TRANSIT
  AT_CUSTOMS
  CUSTOMS_CLEARED
  OUT_FOR_DELIVERY
  READY_FOR_PICKUP  // Disponible au point de retrait
  DELIVERED
  CANCELLED
  ON_HOLD
  EXCEPTION
}

// ============================================
// ENL√àVEMENTS (PICKUPS)
// ============================================

/**
 * Statuts d'une demande d'enl√®vement
 * Workflow: REQUESTED ‚Üí SCHEDULED ‚Üí IN_PROGRESS ‚Üí COMPLETED
 * Possibilit√© d'annulation √† tout moment (CANCELED)
 */
enum PickupStatus {
  REQUESTED      // Demande d'enl√®vement cr√©√©e, en attente de planification
  SCHEDULED      // Enl√®vement planifi√© avec date et cr√©neau horaire
  IN_PROGRESS    // Transporteur en route ou sur place
  COMPLETED      // Enl√®vement effectu√© avec succ√®s
  CANCELED       // Enl√®vement annul√©
}

/**
 * Cr√©neaux horaires pour les enl√®vements
 */
enum PickupTimeSlot {
  MORNING        // Matin (8h-12h)
  AFTERNOON      // Apr√®s-midi (12h-17h)
  EVENING        // Soir√©e (17h-20h)
  SPECIFIC_TIME  // Heure pr√©cise (voir pickupTime)
  FLEXIBLE       // Flexible (toute la journ√©e)
}

/**
 * Mod√®le PickupRequest (Demandes d'enl√®vement)
 * G√®re le workflow complet d'enl√®vement de colis avec notifications et suivi
 *
 * Access Control:
 * - ADMIN : acc√®s complet
 * - OPERATIONS_MANAGER : peut cr√©er, lire, modifier, assigner
 * - FINANCE_MANAGER : peut lire
 * - CLIENT : peut cr√©er et lire ses propres demandes
 * - Transporteur assign√© : peut lire et mettre √† jour le statut
 */
model PickupRequest {
  id         String   @id @default(cuid())

  // Relation avec l'exp√©dition
  shipmentId String
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  // Informations de collecte
  pickupAddress    String
  pickupCity       String
  pickupPostalCode String
  pickupCountry    String
  pickupContact    String?  // Nom du contact sur place
  pickupPhone      String?  // T√©l√©phone du contact

  // Planification
  requestedDate DateTime              // Date souhait√©e par le client
  scheduledDate DateTime?             // Date confirm√©e par l'op√©rateur
  timeSlot      PickupTimeSlot        @default(FLEXIBLE)
  pickupTime    String?               // Heure pr√©cise si SPECIFIC_TIME (format "HH:MM")

  // R√©alisation
  actualPickupDate DateTime?          // Date/heure r√©elle de l'enl√®vement

  // Statut et workflow
  status PickupStatus @default(REQUESTED)

  // Transporteur
  transporterId String?
  transporter   Transporter? @relation(fields: [transporterId], references: [id])
  driverName    String?              // Nom du chauffeur effectuant l'enl√®vement
  driverPhone   String?              // T√©l√©phone du chauffeur
  vehiclePlate  String?              // Plaque d'immatriculation du v√©hicule

  // Instructions et notes
  specialInstructions String?        // Instructions sp√©ciales (code porte, √©tage, etc.)
  accessInstructions  String?        // Instructions d'acc√®s (interphone, parking, etc.)
  internalNotes       String?        // Notes internes (visibles uniquement par l'√©quipe)

  // R√©sultat de l'enl√®vement
  completionNotes String?            // Notes apr√®s enl√®vement (√©tat colis, incidents, etc.)

  // Photos (via relation Document)
  documents Document[]               // Photos de preuve d'enl√®vement, signature, etc.

  // Notifications
  notificationSent    Boolean  @default(false)  // Notification 24h envoy√©e ?
  reminderSent        Boolean  @default(false)  // Rappel J-1 envoy√© ?
  confirmationSent    Boolean  @default(false)  // Confirmation d'enl√®vement envoy√©e ?

  // M√©tadonn√©es
  companyId   String                 // Company propri√©taire (d√©normalis√© depuis shipment)
  company     Company @relation(fields: [companyId], references: [id])

  createdById String
  createdBy   User     @relation("CreatedPickups", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent tout faire
  @@allow('all', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Les clients peuvent cr√©er des demandes et lire les leurs
  @@allow('create', auth().companyId == companyId && auth().role == CLIENT)
  @@allow('read', auth().companyId == companyId && auth().role == CLIENT)

  // Le cr√©ateur peut lire et modifier ses demandes (sauf si COMPLETED ou CANCELED)
  @@allow('read,update', auth().id == createdById && status != COMPLETED && status != CANCELED)

  @@deny('all', true)

  @@index([shipmentId])
  @@index([companyId])
  @@index([status])
  @@index([scheduledDate])
  @@index([requestedDate])
  @@index([transporterId])
}

// ============================================
// TRACKING
// ============================================

/**
 * Mod√®le TrackingEvent (√âv√©nements de suivi)
 * - ADMIN/OPERATIONS_MANAGER : peuvent cr√©er et lire
 * - FINANCE_MANAGER/CLIENT : peuvent lire les events des shipments accessibles
 * - Les tracking events h√©ritent des permissions du Shipment parent
 */
model TrackingEvent {
  id          String         @id @default(cuid())
  shipmentId  String
  shipment    Shipment       @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  status      ShipmentStatus
  location    String
  latitude    Float?
  longitude   Float?
  description String?
  timestamp   DateTime       @default(now())
  metadata    Json?

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent cr√©er et lire
  @@allow('create,read', auth().role == OPERATIONS_MANAGER)

  // Lecture publique pour les tracking events (n√©cessaire pour tracking public)
  // Les clients peuvent lire les events des shipments de leur company
  @@allow('read', auth().companyId == shipment.companyId)

  @@deny('all', true)

  @@index([shipmentId])
  @@index([timestamp])
}

// ============================================
// FACTURATION
// ============================================

/**
 * Mod√®le Invoice (Factures)
 * - ADMIN/FINANCE_MANAGER : acc√®s complet
 * - OPERATIONS_MANAGER : peut lire toutes les factures
 * - CLIENT : peut lire les factures de sa company
 * - Les factures PAID ne peuvent plus √™tre modifi√©es
 */
model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  companyId     String
  company       Company       @relation(fields: [companyId], references: [id])
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  paidDate      DateTime?
  subtotal      Float
  taxRate       Float         @default(0)
  taxAmount     Float
  discount      Float         @default(0)
  total         Float
  currency      String        @default("EUR")
  status        InvoiceStatus @default(DRAFT)
  paymentMethod String?
  shipment      Shipment?
  quoteId       String?
  quote         Quote?        @relation(fields: [quoteId], references: [id])
  notes         String?
  createdById   String
  createdBy     User          @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  items         InvoiceItem[]
  documents     Document[]

  // üîê Access Policies

  // Les admins et finance managers peuvent tout faire
  @@allow('all', auth().role == ADMIN || auth().role == FINANCE_MANAGER)

  // Les operations managers peuvent lire
  @@allow('read', auth().role == OPERATIONS_MANAGER)

  // Les clients peuvent lire les factures de leur company
  @@allow('read', auth().companyId == companyId && auth().role == CLIENT)

  // Les factures pay√©es ne peuvent plus √™tre modifi√©es (r√®gle de s√©curit√©)
  @@deny('update,delete', status == PAID)

  @@deny('all', true)

  @@index([companyId])
  @@index([status])
  @@index([invoiceNumber])
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

/**
 * Mod√®le InvoiceItem (Lignes de facture)
 * - H√©rite des permissions de l'Invoice parent
 */
model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Float
  unitPrice   Float
  amount      Float

  // üîê Access Policies (h√©rite de Invoice)

  @@allow('all', auth().role == ADMIN || auth().role == FINANCE_MANAGER)
  @@allow('read', auth().role == OPERATIONS_MANAGER)
  @@allow('read', auth().companyId == invoice.companyId)
  @@deny('all', invoice.status == PAID) // Ne peut pas modifier si facture pay√©e
  @@deny('all', true)

  @@index([invoiceId])
}

// ============================================
// DEVIS
// ============================================

/**
 * Mod√®le Quote (Devis)
 * - ADMIN/OPERATIONS_MANAGER : peuvent cr√©er et g√©rer tous les devis
 * - FINANCE_MANAGER : peut lire tous les devis
 * - CLIENT : peut lire et demander des devis pour sa company
 */
model Quote {
  id                 String          @id @default(cuid())
  quoteNumber        String          @unique
  companyId          String
  company            Company         @relation(fields: [companyId], references: [id])
  originCountry      String
  destinationCountry String
  transportMode      TransportMode[]
  cargoType          CargoType
  weight             Float

  // Dimensions (optionnelles) - Volume calcul√© = L √ó W √ó H
  // Champs nullable car optionnels dans le formulaire
  length             Float?           // Longueur en m√®tres
  width              Float?           // Largeur en m√®tres
  height             Float?           // Hauteur en m√®tres

  estimatedCost      Float
  validUntil         DateTime
  currency           String          @default("EUR")
  status             QuoteStatus     @default(DRAFT)
  acceptedAt         DateTime?
  rejectedAt         DateTime?
  invoices           Invoice[]
  documents          Document[]
  convertedFromGuest GuestQuote?     @relation("ConvertedFromGuest") // Relation inverse pour conversion
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent cr√©er, lire et modifier
  @@allow('create,read,update', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Les clients peuvent lire et cr√©er des quotes pour leur company
  @@allow('read,create', auth().companyId == companyId && auth().role == CLIENT)

  @@deny('all', true)

  @@index([companyId])
  @@index([status])
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

enum ProspectStatus {
  PENDING      // En attente de finalisation d'inscription
  CONVERTED    // Converti en User
  EXPIRED      // Token d'invitation expir√©
}

// ============================================
// PROSPECTS ET GUEST QUOTES
// ============================================

/**
 * Mod√®le Prospect
 * Repr√©sente une personne qui a demand√© un devis sans cr√©er de compte complet
 *
 * Workflow :
 * 1. Utilisateur non-connect√© demande un devis ‚Üí Cr√©ation Prospect + GuestQuote
 * 2. Email envoy√© avec PDF + lien invitation (token valide 7 jours)
 * 3. Prospect clique sur le lien ‚Üí Finalise inscription ‚Üí Conversion en User
 * 4. GuestQuotes convertis en Quotes li√©s √† la Company du User
 *
 * Access policies :
 * - Lecture publique (pour v√©rification du token)
 * - Cr√©ation publique (calculateur accessible √† tous)
 * - Modification/suppression r√©serv√©e aux ADMIN
 */
model Prospect {
  id                    String         @id @default(cuid())
  email                 String         @unique
  phone                 String?
  name                  String?
  company               String?        // Nom entreprise (texte libre, pas li√© √† Company)

  // Token d'invitation s√©curis√©
  invitationToken       String         @unique @default(cuid())
  invitationExpiresAt   DateTime       // 7 jours apr√®s cr√©ation

  status                ProspectStatus @default(PENDING)

  // Lien vers User si converti
  userId                String?        @unique
  user                  User?          @relation(fields: [userId], references: [id])

  // Relations
  guestQuotes           GuestQuote[]

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  // üîê Access Policies

  // Lecture publique n√©cessaire pour v√©rifier les tokens
  @@allow('read', true)

  // Cr√©ation publique pour le calculateur de devis
  @@allow('create', true)

  // Seuls les admins peuvent modifier ou supprimer
  @@allow('update,delete', auth().role == ADMIN)

  // Par d√©faut, tout est interdit
  @@deny('all', true)

  @@index([email])
  @@index([invitationToken])
  @@index([status])
}

/**
 * Mod√®le GuestQuote (Devis Prospect)
 * Repr√©sente un devis pour un prospect (utilisateur non-connect√©)
 *
 * Diff√©rences avec Quote :
 * - Pas de companyId (li√© √† prospectId)
 * - Num√©ro format GQTE-YYYYMMDD-XXXXX (au lieu de QTE-)
 * - Peut √™tre converti en Quote lors de la cr√©ation du compte
 *
 * Access policies :
 * - Lecture publique (pour afficher dans les emails)
 * - Cr√©ation publique (calculateur)
 * - ADMIN ont acc√®s complet
 */
model GuestQuote {
  id                 String          @id @default(cuid())
  quoteNumber        String          @unique // Format: GQTE-YYYYMMDD-XXXXX

  // Li√© au Prospect (au lieu de Company)
  prospectId         String
  prospect           Prospect        @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  // Champs du devis (identiques √† Quote)
  originCountry      String
  destinationCountry String
  transportMode      TransportMode[]
  cargoType          CargoType
  weight             Float

  // Dimensions (optionnelles) - Volume calcul√© = L √ó W √ó H
  // Champs nullable car optionnels dans le formulaire
  length             Float?           // Longueur en m√®tres
  width              Float?           // Largeur en m√®tres
  height             Float?           // Hauteur en m√®tres

  estimatedCost      Float
  validUntil         DateTime
  currency           String          @default("EUR")

  // Conversion tracking
  convertedToQuoteId String?         @unique
  convertedToQuote   Quote?          @relation("ConvertedFromGuest", fields: [convertedToQuoteId], references: [id])

  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // üîê Access Policies

  // Lecture publique (affichage dans emails)
  @@allow('read', true)

  // Cr√©ation publique (calculateur)
  @@allow('create', true)

  // Les admins ont acc√®s complet
  @@allow('all', auth().role == ADMIN)

  // Par d√©faut, tout est interdit
  @@deny('all', true)

  @@index([prospectId])
  @@index([quoteNumber])
}

// ============================================
// NOTIFICATIONS
// ============================================

/**
 * Mod√®le Notification (Notifications utilisateur)
 * - ADMIN : peut lire et cr√©er toutes les notifications
 * - Chaque user peut lire et modifier ses propres notifications
 */
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Chaque user peut lire et modifier (marquer comme lu) ses propres notifications
  @@allow('read,update', auth().id == userId)

  // Les operations managers peuvent cr√©er des notifications
  @@allow('create', auth().role == OPERATIONS_MANAGER)

  @@deny('all', true)

  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  SHIPMENT_CREATED
  SHIPMENT_PICKED_UP
  SHIPMENT_IN_TRANSIT
  SHIPMENT_DELIVERED
  SHIPMENT_DELAYED
  INVOICE_GENERATED
  INVOICE_PAID
  QUOTE_REQUEST
  CUSTOMS_CLEARED
  DOCUMENT_UPLOADED
}

// ============================================
// GESTION DOCUMENTAIRE
// ============================================

/**
 * Type de document
 */
enum DocumentType {
  INVOICE_SCAN           // Scan de facture
  PROOF_OF_DELIVERY      // Preuve de livraison
  PROOF_OF_PICKUP        // Preuve d'enl√®vement
  PICKUP_SIGNATURE       // Signature d'enl√®vement
  CUSTOMS_DOCUMENT       // Document douanier
  PACKING_LIST           // Liste de colisage
  BILL_OF_LADING         // Connaissement
  CMR                    // Lettre de voiture CMR
  AIRWAY_BILL            // Lettre de transport a√©rien
  CERTIFICATE            // Certificat (origine, conformit√©, etc.)
  PHOTO                  // Photo de la marchandise
  OTHER                  // Autre document
}

/**
 * Mod√®le Document (Gestion documentaire)
 * - ADMIN : acc√®s complet √† tous les documents
 * - OPERATIONS_MANAGER : peut cr√©er, lire et supprimer tous les documents
 * - FINANCE_MANAGER : peut lire tous les documents
 * - CLIENT : peut cr√©er et lire les documents de sa company
 * - L'uploader peut supprimer son propre document
 */
model Document {
  id          String       @id @default(cuid())
  name        String       // Nom du fichier original
  fileUrl     String       // URL du fichier stock√© (UploadThing, S3, etc.)
  fileKey     String       // Cl√© unique du fichier pour suppression
  fileSize    Int          // Taille en octets
  mimeType    String       // Type MIME (application/pdf, image/jpeg, etc.)
  type        DocumentType // Type de document
  description String?      // Description optionnelle

  // Relations (au moins une doit √™tre pr√©sente)
  shipmentId String?
  shipment   Shipment? @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  invoiceId String?
  invoice   Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  quoteId String?
  quote   Quote?    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  pickupRequestId String?
  pickupRequest   PickupRequest? @relation(fields: [pickupRequestId], references: [id], onDelete: Cascade)

  // M√©tadonn√©es
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  uploadedBy  String
  uploader    User     @relation("UploadedDocuments", fields: [uploadedBy], references: [id])
  uploadedAt  DateTime @default(now())

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent cr√©er, lire et supprimer
  @@allow('create,read,delete', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire tous les documents
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Les clients peuvent cr√©er et lire les documents de leur company
  @@allow('create,read', auth().companyId == companyId && auth().role == CLIENT)

  // L'uploader peut supprimer son propre document
  @@allow('delete', auth().id == uploadedBy)

  @@deny('all', true)

  @@index([companyId])
  @@index([shipmentId])
  @@index([invoiceId])
  @@index([quoteId])
  @@index([pickupRequestId])
  @@index([uploadedBy])
}

// ============================================
// TRANSPORTEURS
// ============================================

/**
 * Type de transporteur
 */
enum TransporterType {
  ROAD        // Routier
  SEA         // Maritime
  AIR         // A√©rien
  RAIL        // Ferroviaire
  MULTIMODAL  // Multimodal
}

/**
 * Mod√®le Transporter (Transporteurs/Partenaires de transport)
 * - ADMIN : acc√®s complet
 * - OPERATIONS_MANAGER : peut cr√©er, lire et modifier tous les transporteurs
 * - FINANCE_MANAGER : peut lire tous les transporteurs
 * - CLIENT/VIEWER : peuvent voir les transporteurs actifs
 */
model Transporter {
  id            String          @id @default(cuid())
  name          String          // Nom du transporteur
  type          TransporterType // Type de transport
  email         String          @unique
  phone         String
  address       String?
  city          String?
  postalCode    String?
  country       String?
  website       String?

  // Informations commerciales
  contactPerson String? // Nom du contact principal
  taxId         String? // Num√©ro de TVA
  iban          String? // IBAN pour les paiements

  // M√©tadonn√©es
  notes    String?  // Notes internes
  isActive Boolean  @default(true) // Transporteur actif ou non
  rating   Float?   @default(0) // Note de 0 √† 5

  // Relations
  companyId      String
  company        Company @relation(fields: [companyId], references: [id])
  pickupRequests PickupRequest[] // Enl√®vements assign√©s √† ce transporteur

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent cr√©er, lire et modifier
  @@allow('create,read,update', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Les clients peuvent voir les transporteurs actifs
  @@allow('read', isActive == true && (auth().role == CLIENT || auth().role == VIEWER))

  @@deny('all', true)

  @@index([companyId])
  @@index([type])
  @@map("transporter")
}

// ============================================
// CONFIGURATION DES PRIX
// ============================================

/**
 * Mod√®le PricingConfig (Configuration globale des prix)
 *
 * Stocke tous les param√®tres de tarification utilis√©s dans le calcul des devis.
 * Il ne doit exister qu'une seule instance de ce mod√®le (singleton).
 *
 * Structure des champs JSON :
 * - transportMultipliers : { ROAD: 1.0, SEA: 0.6, AIR: 3.0, RAIL: 0.8 }
 * - cargoTypeSurcharges : { GENERAL: 0, DANGEROUS: 0.5, PERISHABLE: 0.4, ... }
 * - prioritySurcharges : { STANDARD: 0, NORMAL: 0.1, EXPRESS: 0.5, URGENT: 0.3 }
 * - deliverySpeedsPerMode : {
 *     ROAD: { min: 3, max: 7 },
 *     SEA: { min: 20, max: 45 },
 *     AIR: { min: 1, max: 3 },
 *     RAIL: { min: 7, max: 14 }
 *   }
 * - volumetricWeightRatios : { AIR: 167, ROAD: 333, SEA: 1, RAIL: 250 }
 *   ‚Üí D√©finit combien de kg √©quivaut 1 m¬≥ pour chaque mode
 *   ‚Üí Bas√© sur les ratios du PDF : AIR (1/6 = 6000), ROAD (1/3 = 5000), SEA (1/1 = 1000)
 * - useVolumetricWeightPerMode : { AIR: true, ROAD: true, SEA: false, RAIL: true }
 *   ‚Üí Active/d√©sactive le poids volum√©trique par mode
 *   ‚Üí Maritime (SEA) utilise "Poids ou Mesure" (Unit√© Payante) au lieu du poids volum√©trique
 *
 * Access policies :
 * - ADMIN uniquement pour toutes les op√©rations
 */
model PricingConfig {
  id                   String   @id @default(cuid())

  // Taux de base
  baseRatePerKg        Float    @default(0.5) // ‚Ç¨ par kg (ANCIEN - conserv√© pour compatibilit√©)

  // NOUVEAUX : Tarifs par d√©faut pour fallback (si route non configur√©e dans matrice)
  defaultRatePerKg     Float    @default(1.0)   // ‚Ç¨ par kg
  defaultRatePerM3     Float    @default(200.0) // ‚Ç¨ par m¬≥

  // Multiplicateurs par mode de transport (utilis√©s uniquement si route non configur√©e)
  transportMultipliers Json     // { ROAD: Float, SEA: Float, AIR: Float, RAIL: Float }

  // Surcharges par type de cargo (coefficients multiplicateurs, ex: DANGEROUS: 0.5 = +50%)
  cargoTypeSurcharges  Json     // { GENERAL: Float, DANGEROUS: Float, PERISHABLE: Float, ... }

  // Surcharges par priorit√© (coefficients multiplicateurs, ex: NORMAL: 0.1 = +10%)
  prioritySurcharges   Json     // { STANDARD: Float, NORMAL: Float, EXPRESS: Float, URGENT: Float }

  // D√©lais de livraison par mode (en jours)
  deliverySpeedsPerMode Json    // { ROAD: {min, max}, SEA: {min, max}, ... }

  // === NOUVEAUX CHAMPS POUR ALGORITHME PDF ===

  // Ratios de conversion poids volum√©trique : combien de kg = 1 m¬≥
  // Exemple : { AIR: 167, ROAD: 333, SEA: 1, RAIL: 250 }
  // AIR: 167 signifie que 1 m¬≥ = 167 kg (ratio 1/6 = 6000)
  // ROAD: 333 signifie que 1 m¬≥ = 333 kg (ratio 1/3 = 5000)
  // SEA: 1 signifie que 1 m¬≥ = 1 tonne (ratio 1/1 = 1000)
  volumetricWeightRatios Json @default("{\"AIR\":167,\"ROAD\":333,\"SEA\":1,\"RAIL\":250}")

  // Activation du poids volum√©trique par mode de transport
  // Exemple : { AIR: true, ROAD: true, SEA: false, RAIL: true }
  // SEA: false car le maritime utilise "Poids ou Mesure" (Unit√© Payante)
  useVolumetricWeightPerMode Json @default("{\"AIR\":true,\"ROAD\":true,\"SEA\":false,\"RAIL\":true}")

  // M√©tadonn√©es
  updatedById          String
  updatedBy            User     @relation(fields: [updatedById], references: [id])
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // üîê Access Policies

  // Seuls les admins peuvent g√©rer la configuration des prix
  @@allow('all', auth().role == ADMIN)

  @@deny('all', true)

  @@map("pricing_config")
}

/**
 * Mod√®le CountryDistance (Distances entre pays)
 *
 * Table de r√©f√©rence des distances en kilom√®tres entre les pays.
 * Utilis√©e dans le calcul du facteur de distance pour les devis.
 *
 * Contraintes :
 * - Chaque paire (originCountry, destinationCountry) doit √™tre unique
 * - Les distances sont bidirectionnelles (FR->DE = DE->FR)
 *
 * Access policies :
 * - Lecture publique (n√©cessaire pour le calcul des devis publics)
 * - Cr√©ation/Modification/Suppression : ADMIN uniquement
 */
model CountryDistance {
  id                 String   @id @default(cuid())
  originCountry      String   // Code pays ISO (ex: "FR", "DE", "ES")
  destinationCountry String   // Code pays ISO
  distanceKm         Int      // Distance en kilom√®tres

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // üîê Access Policies

  // Lecture publique n√©cessaire pour calcul des devis
  @@allow('read', true)

  // Seuls les admins peuvent cr√©er, modifier ou supprimer
  @@allow('create,update,delete', auth().role == ADMIN)

  @@deny('all', true)

  @@unique([originCountry, destinationCountry])
  @@index([originCountry])
  @@index([destinationCountry])
  @@map("country_distance")
}

/**
 * Mod√®le TransportRate (Tarifs de Transport par Route)
 *
 * Stocke les tarifs sp√©cifiques pour chaque combinaison origine-destination-mode.
 * Permet une tarification granulaire avec des surcharges personnalis√©es par route.
 *
 * Structure :
 * - Cl√© unique : (originCountryCode, destinationCountryCode, transportMode)
 * - Tarifs : ratePerKg (‚Ç¨/kg) et ratePerM3 (‚Ç¨/m¬≥)
 * - Surcharges optionnelles : JSON pour cargo et priorit√©
 *
 * Logique de calcul :
 * 1. prixBase = MAX(poids √ó ratePerKg, volume √ó ratePerM3)
 * 2. Appliquer surcharges cargo de la route (ou fallback PricingConfig)
 * 3. Appliquer surcharges priorit√© de la route (ou fallback PricingConfig)
 *
 * Access policies :
 * - Lecture publique (n√©cessaire pour calcul des devis publics)
 * - Cr√©ation/Modification/Suppression : ADMIN uniquement
 */
model TransportRate {
  id                     String        @id @default(cuid())

  // Cl√© de route
  originCountryCode      String        // Code pays ISO (ex: "FR")
  destinationCountryCode String        // Code pays ISO (ex: "BF")
  transportMode          TransportMode // ROAD | SEA | AIR | RAIL

  // Tarifs de base (requis)
  ratePerKg              Float         // Tarif en ‚Ç¨/kg
  ratePerM3              Float         // Tarif en ‚Ç¨/m¬≥

  // Surcharges personnalis√©es (optionnelles, JSON)
  // Si null, utilise les surcharges globales de PricingConfig
  cargoTypeSurcharges    Json?         // { GENERAL: 0, DANGEROUS: 0.3, ... }
  prioritySurcharges     Json?         // { STANDARD: 0, EXPRESS: 0.5, ... }

  // M√©tadonn√©es
  isActive               Boolean       @default(true) // Permet de d√©sactiver une route
  notes                  String?       // Notes internes
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // üîê Access Policies

  // Lecture publique n√©cessaire pour calcul des devis
  @@allow('read', true)

  // Seuls les admins peuvent cr√©er, modifier ou supprimer
  @@allow('create,update,delete', auth().role == ADMIN)

  @@deny('all', true)

  // Index et contraintes
  @@unique([originCountryCode, destinationCountryCode, transportMode])
  @@index([originCountryCode])
  @@index([destinationCountryCode])
  @@index([transportMode])
  @@index([isActive])
  @@map("transport_rate")
}

// ============================================
// GESTION DES PAYS
// ============================================

/**
 * Mod√®le Country (Pays)
 *
 * Table de r√©f√©rence des pays disponibles pour les exp√©ditions.
 * Utilis√©e pour les s√©lecteurs de pays d'origine et de destination.
 *
 * Structure :
 * - code : Code ISO 3166-1 alpha-2 (ex: "FR", "DE", "US")
 * - name : Nom du pays en fran√ßais (ex: "France", "Allemagne", "√âtats-Unis")
 * - isActive : Indique si le pays est actif pour les exp√©ditions
 *
 * Access policies :
 * - Lecture publique (n√©cessaire pour les formulaires de devis publics)
 * - Cr√©ation/Modification/Suppression : ADMIN uniquement
 */
model Country {
  id        String   @id @default(cuid())
  code      String   @unique // Code ISO 3166-1 alpha-2 (ex: "FR", "DE")
  name      String   // Nom en fran√ßais (ex: "France", "Allemagne")
  isActive  Boolean  @default(true) // Pays activ√© pour les exp√©ditions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîê Access Policies

  // Lecture publique n√©cessaire pour les formulaires de devis
  @@allow('read', true)

  // Seuls les admins peuvent cr√©er, modifier ou supprimer
  @@allow('create,update,delete', auth().role == ADMIN)

  @@deny('all', true)

  @@index([code])
  @@index([isActive])
  @@map("country")
}
