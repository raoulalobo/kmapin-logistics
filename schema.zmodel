// Sch√©ma Zenstack - Faso Fret Logistics
// Application de gestion de fret multi-modal avec Access Control

/**
 * Generator Prisma standard
 * G√©n√®re les binaires pour Linux (Vercel) et le syst√®me local
 */
generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

/**
 * Plugin Zenstack pour hooks React Query
 */
plugin hooks {
  provider = '@zenstackhq/tanstack-query'
  target = 'react'
  version = 'v5'
  output = "../src/lib/hooks"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CONTEXTE D'AUTHENTIFICATION
// ============================================

/**
 * Type Auth - D√©finit la forme du contexte utilisateur pour Zenstack
 *
 * CRITIQUE : Ce type est obligatoire pour que Zenstack comprenne la structure
 * de auth() utilis√©e dans les access policies.
 *
 * Sans ce type, auth().role, auth().id, etc. ne fonctionnent PAS correctement
 * et les policies sont rejet√©es m√™me si l'utilisateur a les bonnes permissions.
 *
 * Le contexte est fourni via enhance(prisma, { user: context })
 */
type Auth {
  id        String   @id      // ID de l'utilisateur (depuis Better Auth)
  role      UserRole          // R√¥le de l'utilisateur (ADMIN, CLIENT, etc.)
  companyId String?           // ID de la company (pour multi-tenancy)

  @@auth                       // Directive Zenstack : marque ce type comme contexte auth()
}

// ============================================
// AUTHENTIFICATION (Better Auth)
// ============================================

/**
 * Mod√®le User avec access control
 * - ADMIN : acc√®s complet √† tous les users
 * - OPERATIONS_MANAGER/FINANCE_MANAGER : peuvent lire les users de leur entreprise
 * - CLIENT/VIEWER : peuvent lire uniquement leur propre profil
 * - Tous les users peuvent modifier leur propre profil
 */
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified Boolean   @default(false) // Better Auth: Boolean au lieu de DateTime
  name          String?
  image         String?
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations Better Auth
  accounts Account[]
  sessions Session[]

  // Champs business
  role        UserRole @default(CLIENT)
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id])
  permissions Json?

  // Relations
  createdShipments   Shipment[] @relation("CreatedBy")
  userShipments      Shipment[] @relation("UserShipments") // Exp√©ditions de cet utilisateur (propri√©t√© hybride)
  createdInvoices    Invoice[]  @relation("CreatedBy")
  userInvoices       Invoice[]  @relation("UserInvoices")  // Factures de cet utilisateur (propri√©t√© hybride)
  userDocuments      Document[] @relation("UserDocuments")  // Documents de cet utilisateur (propri√©t√© hybride)
  uploadedDocuments  Document[] @relation("UploadedDocuments")
  prospect           Prospect?  // Relation 1:1 avec Prospect (si converti)
  pricingConfigs     PricingConfig[] // Configurations de prix modifi√©es par cet utilisateur
  createdPickups     PickupRequest[] @relation("CreatedPickups") // Demandes d'enl√®vement cr√©√©es
  pickupLogs         PickupLog[] @relation("PickupLogChangedBy") // Logs d'enl√®vement effectu√©s
  userPickups        PickupRequest[] @relation("UserPickups") // Demandes d'enl√®vement de cet utilisateur (connect√© ou rattach√©)

  createdPurchases   PurchaseRequest[] @relation("CreatedPurchases") // Demandes d'achat cr√©√©es
  purchaseLogs       PurchaseLog[] @relation("PurchaseLogChangedBy") // Logs d'achat effectu√©s
  userPurchases      PurchaseRequest[] @relation("UserPurchases") // Demandes d'achat de cet utilisateur (connect√© ou rattach√©)

  treatedQuotes      Quote[] @relation("QuoteTreatmentAgent") // Devis trait√©s par cet agent

  performedTrackingEvents TrackingEvent[] @relation("PerformedTrackingEvents") // √âv√©nements de tracking effectu√©s par cet agent

  // Relations pour les devis (pattern cr√©ation sans compte)
  userQuotes         Quote[] @relation("UserQuotes")    // Devis rattach√©s √† cet utilisateur
  createdQuotes      Quote[] @relation("CreatedQuotes") // Devis cr√©√©s par cet utilisateur

  // üîê Access Policies Zenstack

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Chaque user peut lire et modifier son propre profil
  @@allow('read,update', auth().id == id)

  // Les managers peuvent lire les users de leur entreprise
  @@allow('read', auth().companyId == companyId &&
    (auth().role == OPERATIONS_MANAGER || auth().role == FINANCE_MANAGER))

  // Par d√©faut, tout est interdit (principe de moindre privil√®ge)
  @@deny('all', true)

  @@index([companyId])
  @@map("user") // Better Auth: nom de table minuscule
}

enum UserRole {
  ADMIN
  OPERATIONS_MANAGER
  FINANCE_MANAGER
  CLIENT
  VIEWER
}

/**
 * Mod√®le Account (OAuth providers + Better Auth)
 * - Compatible avec Better Auth v1.4+ (sch√©ma officiel)
 * - Chaque user peut g√©rer ses propres comptes OAuth
 * - Les admins ont acc√®s complet
 */
model Account {
  id                    String    @id @default(cuid())
  accountId             String    // Better Auth: identifiant du compte chez le provider
  providerId            String    // Better Auth: identifiant du provider (google, credential, etc.)
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   // OAuth: access token
  refreshToken          String?   // OAuth: refresh token
  idToken               String?   // OAuth: id token
  accessTokenExpiresAt  DateTime? // OAuth: expiration de l'access token
  refreshTokenExpiresAt DateTime? // OAuth: expiration du refresh token
  scope                 String?   // OAuth: scopes autoris√©s
  password              String?   // Better Auth: hashed password for email/password authentication
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // üîê Access Policies
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().id == userId)
  @@deny('all', true)

  @@unique([providerId, accountId]) // Better Auth: contrainte unique sur provider + accountId
  @@index([userId])
  @@map("account") // Better Auth: nom de table minuscule
}

/**
 * Mod√®le Session (Better Auth)
 * - Conforme au sch√©ma Better Auth officiel
 * - Stocke les sessions avec token, IP et user agent
 * - Chaque user peut g√©rer ses propres sessions
 * - Les admins ont acc√®s complet
 */
model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime // Better Auth: expiresAt au lieu de expires
  token     String   @unique // Better Auth: token au lieu de sessionToken
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  // Better Auth: tracking IP
  userAgent String?  // Better Auth: tracking user agent
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // üîê Access Policies
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().id == userId)
  @@deny('all', true)

  @@index([userId])
  @@map("session") // Better Auth: nom de table minuscule
}

/**
 * Mod√®le VerificationToken (email verification, password reset)
 * - Accessible en lecture publique (n√©cessaire pour la v√©rification)
 * - Cr√©ation/modification r√©serv√©e au syst√®me
 */
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  // üîê Access Policies
  @@allow('read', true) // Lecture publique n√©cessaire
  @@allow('all', auth().role == ADMIN)
  @@deny('all', true)

  @@unique([identifier, token])
}

/**
 * Mod√®le Verification (utilis√© par Better Auth)
 * - Pour la v√©rification d'email et la r√©initialisation de mot de passe
 * - G√®re les tokens avec expiration
 */
model Verification {
  id         String   @id @default(cuid())
  identifier String   // Email ou identifiant de l'utilisateur
  value      String   // Token de v√©rification
  expiresAt  DateTime // Date d'expiration du token
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // üîê Access Policies
  @@allow('read', true) // Lecture publique n√©cessaire pour Better Auth
  @@allow('all', auth().role == ADMIN)
  @@deny('all', true)

  @@index([identifier])
  @@map("verification")
}

// ============================================
// ENTREPRISES & CLIENTS
// ============================================

/**
 * Mod√®le Company (Entreprises/Clients)
 * - ADMIN : acc√®s complet
 * - OPERATIONS_MANAGER/FINANCE_MANAGER : peuvent voir toutes les companies
 * - CLIENT/VIEWER : peuvent voir uniquement leur propre company
 * - Les users d'une company peuvent modifier certains champs de leur company
 */
model Company {
  id         String   @id @default(cuid())
  name       String
  legalName  String?
  taxId      String?  @unique
  email      String
  phone      String?
  address    String
  city       String
  postalCode String?
  country    String
  website    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  users          User[]
  shipments      Shipment[]
  invoices       Invoice[]
  quotes         Quote[]
  documents       Document[]
  transporters    Transporter[]
  pickupRequests  PickupRequest[] // Demandes d'enl√®vement de cette company
  purchaseRequests PurchaseRequest[] // Demandes d'achat de cette company

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations et finance managers peuvent lire toutes les companies
  @@allow('read', auth().role == OPERATIONS_MANAGER || auth().role == FINANCE_MANAGER)

  // Les users d'une company peuvent lire et modifier leur company
  @@allow('read,update', auth().companyId == id)

  @@deny('all', true)

  @@index([taxId])
}

// ============================================
// EXP√âDITIONS
// ============================================

/**
 * Mod√®le Shipment (Exp√©ditions)
 * - ADMIN : acc√®s complet
 * - OPERATIONS_MANAGER : peut cr√©er, lire, modifier toutes les exp√©ditions
 * - FINANCE_MANAGER : peut lire toutes les exp√©ditions
 * - CLIENT : peut lire uniquement les exp√©ditions de sa company
 * - PARTICULIER : peut lire ses propres exp√©ditions (via userId direct)
 * - Le cr√©ateur peut modifier tant que status != DELIVERED
 *
 * PROPRI√âT√â HYBRIDE :
 * - Si companyId != null : l'exp√©dition appartient √† la company
 * - Si companyId == null : l'exp√©dition appartient directement au userId
 */
model Shipment {
  id             String   @id @default(cuid())
  trackingNumber String   @unique

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PROPRI√âT√â HYBRIDE (Company ou User direct)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Company (NULL si particulier sans entreprise)
  companyId      String?
  company        Company?  @relation(fields: [companyId], references: [id])

  // Propri√©taire direct (pour particuliers sans company)
  // Si companyId est NULL, userId d√©termine le propri√©taire
  userId         String?
  user           User?     @relation("UserShipments", fields: [userId], references: [id])

  // Origine & Destination
  originAddress      String
  originCity         String
  originPostalCode   String
  originCountry      String
  originContact      String?
  originPhone        String?

  destinationAddress    String
  destinationCity       String
  destinationPostalCode String
  destinationCountry    String
  destinationContact    String?
  destinationPhone      String?

  // D√©tails marchandise
  cargoType           CargoType
  weight              Float

  // Dimensions (optionnelles) - Volume calcul√© = L √ó W √ó H
  length              Float?            // Longueur en m√®tres
  width               Float?            // Largeur en m√®tres
  height              Float?            // Hauteur en m√®tres

  packageCount        Int
  value               Float?
  currency            String          @default("EUR")
  description         String
  specialInstructions String?

  // Transport
  transportMode TransportMode[]
  priority      Priority        @default(STANDARD)
  isDangerous   Boolean         @default(false)
  isFragile     Boolean         @default(false)

  // Dates
  requestedPickupDate   DateTime?
  actualPickupDate      DateTime?
  estimatedDeliveryDate DateTime?
  actualDeliveryDate    DateTime?

  // Statut
  status ShipmentStatus @default(DRAFT)

  // Financier
  estimatedCost Float?
  actualCost    Float?
  invoiceId     String?  @unique
  invoice       Invoice? @relation(fields: [invoiceId], references: [id])

  // M√©tadonn√©es
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  trackingEvents TrackingEvent[]
  documents      Document[]
  pickupRequests PickupRequest[]
  fromQuote      Quote?          @relation("QuoteToShipment") // Devis √† l'origine de cette exp√©dition

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent cr√©er, lire et modifier
  @@allow('create,read,update', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire toutes les exp√©ditions
  @@allow('read', auth().role == FINANCE_MANAGER)

  // PROPRI√âT√â HYBRIDE - Lecture par company
  // Les clients peuvent lire les exp√©ditions de leur company
  @@allow('read', companyId != null && auth().companyId == companyId && auth().role == CLIENT)

  // PROPRI√âT√â HYBRIDE - Lecture par userId (particuliers sans company)
  // Le propri√©taire direct peut lire et modifier ses exp√©ditions
  @@allow('read,update', companyId == null && userId != null && auth().id == userId && status != DELIVERED)

  // Le cr√©ateur peut modifier tant que status != DELIVERED
  @@allow('read,update', auth().id == createdById && status != DELIVERED)

  @@deny('all', true)

  @@index([companyId])
  @@index([userId])           // Index pour propri√©t√© hybride
  @@index([trackingNumber])
  @@index([status])
  @@index([createdAt])
}

enum CargoType {
  GENERAL
  DANGEROUS
  PERISHABLE
  FRAGILE
  BULK
  CONTAINER
  PALLETIZED
  OTHER
}

enum TransportMode {
  ROAD
  SEA
  AIR
  RAIL
}

enum Priority {
  STANDARD
  EXPRESS
  URGENT
}

enum ShipmentStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PICKED_UP
  IN_TRANSIT
  AT_CUSTOMS
  CUSTOMS_CLEARED
  OUT_FOR_DELIVERY
  READY_FOR_PICKUP  // Disponible au point de retrait
  DELIVERED
  CANCELLED
  ON_HOLD
  EXCEPTION
}

// ============================================
// ENL√àVEMENTS (PICKUPS)
// ============================================

/**
 * Statuts simplifi√©s pour le workflow Sprint 1
 * Workflow: NOUVEAU ‚Üí PRISE_EN_CHARGE ‚Üí EFFECTUE
 * Annulation possible √† tout moment: ANNULE (avec raison obligatoire)
 */
enum PickupStatus {
  NOUVEAU         // Demande cr√©√©e, en attente de traitement (24-48h) - US-1.1
  PRISE_EN_CHARGE // Agent Faso Fret a pris en charge la demande - US-3.2
  EFFECTUE        // Enl√®vement r√©alis√© avec succ√®s - US-3.2
  ANNULE          // Annul√© avec raison obligatoire - US-3.3
}

/**
 * Cr√©neaux horaires pour les enl√®vements
 */
enum PickupTimeSlot {
  MORNING        // Matin (8h-12h)
  AFTERNOON      // Apr√®s-midi (12h-17h)
  EVENING        // Soir√©e (17h-20h)
  SPECIFIC_TIME  // Heure pr√©cise (voir pickupTime)
  FLEXIBLE       // Flexible (toute la journ√©e)
}

/**
 * Mod√®le PickupRequest UNIFI√â
 *
 * G√®re √† la fois :
 * - Demandes sans compte (US-1.1) : userId = null, acc√®s via trackingToken
 * - Demandes avec compte (US-1.4) : userId rempli d√®s la cr√©ation
 * - Rattachement automatique (US-1.3) : matching par contactEmail/contactPhone
 *
 * Access Control:
 * - Lecture publique via trackingToken (72h) ‚Üí US-1.2
 * - Cr√©ation publique ‚Üí US-1.1
 * - ADMIN/OPERATIONS_MANAGER : acc√®s complet ‚Üí US-3.1, US-3.2, US-3.3
 * - User propri√©taire : lecture/modification ‚Üí US-2.3, US-1.4
 */
model PickupRequest {
  id                 String   @id @default(cuid())

  // ============================================
  // TRACKING ET ACC√àS PUBLIC (US-1.1, US-1.2)
  // ============================================

  trackingNumber     String   @unique      // Format: PK-YYYYMMDD-XXXXX
  trackingToken      String   @unique @default(cuid())  // Token unique pour suivi public
  tokenExpiresAt     DateTime              // Token valide 72h (US-1.2)

  // ============================================
  // RATTACHEMENT COMPTE (US-1.3, US-1.4)
  // ============================================

  userId             String?                // Null si non connect√©, rempli si connect√© ou apr√®s rattachement
  user               User?    @relation("UserPickups", fields: [userId], references: [id])
  isAttachedToAccount Boolean @default(false) // Indique si rattach√© √† un compte

  // ============================================
  // INFORMATIONS DE CONTACT (pour matching US-1.3)
  // ============================================

  contactEmail       String               // Email de contact (utilis√© pour matching)
  contactPhone       String               // T√©l√©phone de contact (utilis√© pour matching)
  contactName        String?              // Nom du contact sur place

  // ============================================
  // ADRESSE D'ENL√àVEMENT
  // ============================================

  pickupAddress      String
  pickupCity         String
  pickupPostalCode   String
  pickupCountry      String @default("FR")

  // ============================================
  // PLANIFICATION
  // ============================================

  requestedDate      DateTime              // Date souhait√©e par le client
  scheduledDate      DateTime?             // Date confirm√©e par l'agent
  actualPickupDate   DateTime?             // Date/heure r√©elle de l'enl√®vement (gard√© pour performance)
  timeSlot           PickupTimeSlot @default(FLEXIBLE)
  pickupTime         String?               // Heure pr√©cise si SPECIFIC_TIME (format "HH:MM")

  // ============================================
  // D√âTAILS MARCHANDISE
  // ============================================

  cargoType          String?               // Type de marchandise (texte libre)
  estimatedWeight    Float?                // Poids estim√© en kg
  estimatedVolume    Float?                // Volume estim√© en m¬≥
  packageCount       Int?                  // Nombre de colis
  description        String?    @db.Text   // Description d√©taill√©e

  // ============================================
  // INSTRUCTIONS
  // ============================================

  specialInstructions String?  @db.Text   // Instructions sp√©ciales (code porte, √©tage...)
  accessInstructions  String?  @db.Text   // Instructions d'acc√®s (interphone, parking...)
  internalNotes       String?  @db.Text   // Notes internes (visibles uniquement par agents)

  // ============================================
  // WORKFLOW ET STATUT (US-3.2)
  // ============================================

  status             PickupStatus @default(NOUVEAU)

  // ============================================
  // ANNULATION (US-3.3)
  // ============================================

  cancellationReason String?   @db.Text   // Obligatoire si status = ANNULE (validation applicative)

  // ============================================
  // TRANSPORTEUR (optionnel, assign√© par agent)
  // ============================================

  transporterId      String?
  transporter        Transporter? @relation(fields: [transporterId], references: [id])
  driverName         String?              // Nom du chauffeur
  driverPhone        String?              // T√©l√©phone du chauffeur
  vehiclePlate       String?              // Plaque d'immatriculation
  completionNotes    String?   @db.Text   // Notes apr√®s enl√®vement

  // ============================================
  // RELATIONS
  // ============================================

  shipmentId         String?
  shipment           Shipment? @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  documents          Document[]            // Photos, signatures, preuves
  logs               PickupLog[]           // Historique complet des √©v√©nements (remplace statusHistory)

  // ============================================
  // M√âTADONN√âES
  // ============================================

  companyId          String?               // Null si non rattach√©, sinon company du user
  company            Company?  @relation(fields: [companyId], references: [id])

  createdById        String?               // Null si cr√©ation publique
  createdBy          User?     @relation("CreatedPickups", fields: [createdById], references: [id])

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // ============================================
  // üîê ACCESS POLICIES
  // ============================================

  // US-1.1 : Cr√©ation publique (formulaire non connect√©)
  // NOTE: La lecture publique via token (US-1.2) est g√©r√©e par Server Action
  // d√©di√©e qui utilise le client Prisma standard (non enhanced) car le token
  // n'est pas dans le contexte auth()
  @@allow('create', true)

  // US-3.1, US-3.2, US-3.3 : Admins et operations managers peuvent tout faire
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // US-1.4, US-2.3 : User propri√©taire peut lire et modifier ses demandes (sauf si termin√©es)
  // NOTE : Zenstack a un probl√®me avec cette r√®gle - voir ZENSTACK_ISSUE.md
  // En attendant, le filtrage est fait manuellement dans les Server Actions
  @@allow('read,update', userId != null && auth().id == userId && status != EFFECTUE && status != ANNULE)

  // Les clients peuvent lire les demandes de leur company
  @@allow('read', auth().companyId == companyId && auth().role == CLIENT)

  @@deny('all', true)

  // ============================================
  // INDEXES (optimisation requ√™tes)
  // ============================================

  @@index([trackingNumber])    // Recherche par num√©ro (US-3.1)
  @@index([trackingToken])     // Acc√®s public (US-1.2)
  @@index([userId])            // Historique user (US-2.3)
  @@index([contactEmail])      // Matching rattachement (US-1.3)
  @@index([contactPhone])      // Matching rattachement (US-1.3)
  @@index([status])            // Filtres back-office (US-3.1)
  @@index([companyId])         // Multi-tenancy
  @@index([shipmentId])        // Relations
  @@index([transporterId])     // Assignation transporteur
  @@index([createdAt])         // Tri chronologique
  @@index([status, createdAt]) // Composite pour filtres + tri optimis√©

  @@map("pickup_request")
}

/**
 * Mod√®le PickupLog (Historique complet des √©v√©nements)
 *
 * Enregistre TOUS les √©v√©nements sur une demande d'enl√®vement :
 * - Changements de statut (US-3.2, US-3.4)
 * - Annulations avec raison (US-3.3)
 * - Rattachement √† un compte (US-1.3)
 * - Assignation transporteur
 * - Modification de planification
 *
 * Utilis√© pour :
 * - Audit trail complet
 * - Temps r√©el back-office (US-3.4)
 * - Reconstitution de l'historique
 *
 * Access Control:
 * - ADMIN/OPERATIONS_MANAGER : lecture/√©criture compl√®te
 * - FINANCE_MANAGER : lecture seule
 * - User propri√©taire : lecture des logs de ses demandes
 * - Lecture publique via token (pour suivi transparent)
 */
model PickupLog {
  id        String   @id @default(cuid())

  // Relation avec la demande d'enl√®vement
  pickupId  String
  pickup    PickupRequest @relation(fields: [pickupId], references: [id], onDelete: Cascade)

  // Changement de statut (peut √™tre null pour d'autres types d'√©v√©nements)
  oldStatus PickupStatus?  // Null pour le premier log (cr√©ation)
  newStatus PickupStatus?  // Null si pas de changement de statut

  // Type d'√©v√©nement (pour diff√©rencier les logs)
  // Valeurs: "CREATED", "STATUS_CHANGED", "ATTACHED_TO_ACCOUNT", "DRIVER_ASSIGNED", etc.
  eventType String

  // Auteur du changement
  changedById String?      // Null si changement automatique (syst√®me)
  changedBy   User?   @relation("PickupLogChangedBy", fields: [changedById], references: [id])

  // D√©tails du changement
  notes       String? @db.Text  // Raison annulation, commentaire, etc.
  metadata    Json?             // Donn√©es additionnelles flexibles (ex: ancien/nouveau transporteur)

  // Horodatage
  createdAt   DateTime @default(now())

  // üîê Access Policies

  // Admins et operations managers peuvent tout faire
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().role == OPERATIONS_MANAGER)

  // Finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // User propri√©taire peut lire les logs de ses demandes
  @@allow('read', auth().id == pickup.userId)

  // NOTE: La lecture publique via token est g√©r√©e par Server Action
  // d√©di√©e qui utilise le client Prisma standard (non enhanced)

  @@deny('all', true)

  // Indexes pour performance
  @@index([pickupId])           // R√©cup√©rer l'historique d'une demande
  @@index([createdAt])          // Tri chronologique
  @@index([eventType])          // Filtrer par type d'√©v√©nement
  @@index([changedById])        // Tracer les actions d'un utilisateur
  @@index([pickupId, createdAt]) // Composite pour historique optimis√©

  @@map("pickup_log")
}

// ============================================
// ACHATS D√âL√âGU√âS (PURCHASE REQUESTS)
// ============================================

/**
 * Statuts d'une demande d'achat d√©l√©gu√©
 */
enum PurchaseStatus {
  NOUVEAU    // Demande cr√©√©e, en attente de traitement (24-48h)
  EN_COURS   // Faso Fret a pris en charge l'achat
  LIVRE      // Produit achet√© et livr√© au client
  ANNULE     // Annul√© avec raison obligatoire
}

/**
 * Modes de livraison pour les achats
 */
enum DeliveryMode {
  STANDARD   // Standard (5-7 jours)
  EXPRESS    // Express (2-3 jours, +20% frais)
  URGENT     // Urgent (24-48h, +50% frais)
}

/**
 * Mod√®le PurchaseRequest UNIFI√â
 *
 * G√®re √† la fois :
 * - Demandes sans compte : userId = null, acc√®s via trackingToken
 * - Demandes avec compte : userId rempli d√®s la cr√©ation
 * - Rattachement automatique : matching par contactEmail/contactPhone
 *
 * Workflow :
 * 1. Client cr√©e demande (avec ou sans compte)
 * 2. Faso Fret prend en charge (EN_COURS)
 * 3. Achat effectu√© et livraison
 * 4. Statut LIVRE avec confirmation
 *
 * Access Control :
 * - Lecture publique via trackingToken (72h)
 * - Cr√©ation publique (formulaire non connect√©)
 * - ADMIN/OPERATIONS_MANAGER : acc√®s complet
 * - User propri√©taire : lecture/modification
 */
model PurchaseRequest {
  id                 String   @id @default(cuid())

  // ============================================
  // TRACKING ET ACC√àS PUBLIC
  // ============================================

  trackingNumber     String   @unique      // Format: PR-YYYYMMDD-XXXXX
  trackingToken      String   @unique @default(cuid())  // Token unique pour suivi public
  tokenExpiresAt     DateTime              // Token valide 72h

  // ============================================
  // RATTACHEMENT COMPTE
  // ============================================

  userId             String?                // Null si non connect√©, rempli si connect√© ou apr√®s rattachement
  user               User?    @relation("UserPurchases", fields: [userId], references: [id])
  isAttachedToAccount Boolean @default(false) // Indique si rattach√© √† un compte

  // ============================================
  // INFORMATIONS DE CONTACT (pour matching)
  // ============================================

  contactEmail       String               // Email de contact (utilis√© pour matching)
  contactPhone       String               // T√©l√©phone de contact (utilis√© pour matching)
  contactName        String?              // Nom du contact

  // ============================================
  // INFORMATIONS PRODUIT
  // ============================================

  productName        String               // Nom/description du produit √† acheter
  productUrl         String?   @db.Text  // URL du produit (si disponible)
  quantity           Int       @default(1) // Quantit√© √† acheter
  estimatedPrice     Float?               // Prix estim√© par le client (‚Ç¨)
  maxBudget          Float?               // Budget maximum autoris√© (‚Ç¨)
  productDescription String?   @db.Text  // Description d√©taill√©e du produit

  // ============================================
  // ADRESSE DE LIVRAISON
  // ============================================

  deliveryAddress    String
  deliveryCity       String
  deliveryPostalCode String
  deliveryCountry    String @default("FR")

  // ============================================
  // PLANIFICATION ET LIVRAISON
  // ============================================

  requestedDate      DateTime              // Date de livraison souhait√©e
  deliveryMode       DeliveryMode @default(STANDARD)
  actualDeliveryDate DateTime?             // Date/heure r√©elle de livraison

  // ============================================
  // INSTRUCTIONS
  // ============================================

  specialInstructions String?  @db.Text   // Instructions sp√©ciales (couleur, taille, etc.)
  internalNotes       String?  @db.Text   // Notes internes (visibles uniquement par agents)

  // ============================================
  // WORKFLOW ET STATUT
  // ============================================

  status             PurchaseStatus @default(NOUVEAU)

  // ============================================
  // ANNULATION
  // ============================================

  cancellationReason String?   @db.Text   // Obligatoire si status = ANNULE

  // ============================================
  // CO√õTS R√âELS (remplis par agent)
  // ============================================

  actualProductCost  Float?               // Co√ªt r√©el d'achat du produit
  deliveryCost       Float?               // Frais de livraison
  serviceFee         Float?               // Frais de service (15% min 10‚Ç¨)
  totalCost          Float?               // Co√ªt total final

  // ============================================
  // PREUVES D'ACHAT
  // ============================================

  purchaseProof      String?   @db.Text   // URL ou r√©f√©rence de la preuve d'achat
  completionNotes    String?   @db.Text   // Notes apr√®s livraison

  // ============================================
  // CONDITIONS ACCEPT√âES
  // ============================================

  acceptedTerms      Boolean   @default(false) // Conditions g√©n√©rales accept√©es
  acceptedUrgentFee  Boolean   @default(false) // Acceptation frais urgence (+20%)
  acceptedPricing    Boolean   @default(false) // Acceptation structure prix (produit + livraison + 15% service)

  // ============================================
  // RELATIONS
  // ============================================

  documents          Document[]            // Preuves d'achat, photos, factures
  logs               PurchaseLog[]         // Historique complet des √©v√©nements

  // ============================================
  // M√âTADONN√âES
  // ============================================

  companyId          String?               // Null si non rattach√©, sinon company du user
  company            Company?  @relation(fields: [companyId], references: [id])

  createdById        String?               // Null si cr√©ation publique
  createdBy          User?     @relation("CreatedPurchases", fields: [createdById], references: [id])

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // ============================================
  // üîê ACCESS POLICIES
  // ============================================

  // Cr√©ation publique (formulaire non connect√©)
  @@allow('create', true)

  // Admins et operations managers peuvent tout faire
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // User propri√©taire peut lire et modifier ses demandes (sauf si termin√©es)
  @@allow('read,update', userId != null && auth().id == userId && status != LIVRE && status != ANNULE)

  // Les clients peuvent lire les demandes de leur company
  @@allow('read', auth().companyId == companyId && auth().role == CLIENT)

  @@deny('all', true)

  // ============================================
  // INDEXES (optimisation requ√™tes)
  // ============================================

  @@index([trackingNumber])    // Recherche par num√©ro
  @@index([trackingToken])     // Acc√®s public
  @@index([userId])            // Historique user
  @@index([contactEmail])      // Matching rattachement
  @@index([contactPhone])      // Matching rattachement
  @@index([status])            // Filtres back-office
  @@index([companyId])         // Multi-tenancy
  @@index([createdAt])         // Tri chronologique
  @@index([status, createdAt]) // Composite pour filtres + tri optimis√©

  @@map("purchase_request")
}

/**
 * Mod√®le PurchaseLog (Historique complet des √©v√©nements)
 *
 * Enregistre TOUS les √©v√©nements sur une demande d'achat :
 * - Changements de statut
 * - Annulations avec raison
 * - Rattachement √† un compte
 * - Modifications de prix/budget
 *
 * Utilis√© pour :
 * - Audit trail complet
 * - Reconstitution de l'historique
 * - Transparence client
 *
 * Access Control :
 * - ADMIN/OPERATIONS_MANAGER : lecture/√©criture compl√®te
 * - FINANCE_MANAGER : lecture seule
 * - User propri√©taire : lecture des logs de ses demandes
 */
model PurchaseLog {
  id        String   @id @default(cuid())

  // Relation avec la demande d'achat
  purchaseId  String
  purchase    PurchaseRequest @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  // Changement de statut
  oldStatus   PurchaseStatus?  // Null pour le premier log (cr√©ation)
  newStatus   PurchaseStatus?  // Null si pas de changement de statut

  // Type d'√©v√©nement
  // Valeurs: "CREATED", "STATUS_CHANGED", "ATTACHED_TO_ACCOUNT", "PRICE_UPDATED", etc.
  eventType   String

  // Auteur du changement
  changedById String?      // Null si changement automatique (syst√®me)
  changedBy   User?   @relation("PurchaseLogChangedBy", fields: [changedById], references: [id])

  // D√©tails du changement
  notes       String? @db.Text  // Raison annulation, commentaire, etc.
  metadata    Json?             // Donn√©es additionnelles flexibles

  // Horodatage
  createdAt   DateTime @default(now())

  // üîê Access Policies

  // Admins et operations managers peuvent tout faire
  @@allow('all', auth().role == ADMIN)
  @@allow('all', auth().role == OPERATIONS_MANAGER)

  // Finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // User propri√©taire peut lire les logs de ses demandes
  @@allow('read', auth().id == purchase.userId)

  @@deny('all', true)

  // Indexes pour performance
  @@index([purchaseId])           // R√©cup√©rer l'historique d'une demande
  @@index([createdAt])            // Tri chronologique
  @@index([eventType])            // Filtrer par type d'√©v√©nement
  @@index([changedById])          // Tracer les actions d'un utilisateur
  @@index([purchaseId, createdAt]) // Composite pour historique optimis√©

  @@map("purchase_log")
}

// ============================================
// TRACKING
// ============================================

/**
 * Mod√®le TrackingEvent (√âv√©nements de suivi)
 * - ADMIN/OPERATIONS_MANAGER : peuvent cr√©er et lire
 * - FINANCE_MANAGER/CLIENT : peuvent lire les events des shipments accessibles
 * - Les tracking events h√©ritent des permissions du Shipment parent
 */
model TrackingEvent {
  id          String         @id @default(cuid())
  shipmentId  String
  shipment    Shipment       @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  status      ShipmentStatus
  location    String
  latitude    Float?
  longitude   Float?
  description String?
  timestamp   DateTime       @default(now())
  metadata    Json?

  // Agent qui a effectu√© l'action (optionnel pour r√©trocompatibilit√©)
  performedById String?
  performedBy   User?   @relation("PerformedTrackingEvents", fields: [performedById], references: [id])

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent cr√©er et lire
  @@allow('create,read', auth().role == OPERATIONS_MANAGER)

  // Lecture publique pour les tracking events (n√©cessaire pour tracking public)
  // Les clients peuvent lire les events des shipments de leur company
  @@allow('read', auth().companyId == shipment.companyId)

  @@deny('all', true)

  @@index([shipmentId])
  @@index([timestamp])
}

// ============================================
// FACTURATION
// ============================================

/**
 * Mod√®le Invoice (Factures)
 * - ADMIN/FINANCE_MANAGER : acc√®s complet
 * - OPERATIONS_MANAGER : peut lire toutes les factures
 * - CLIENT : peut lire les factures de sa company
 * - PARTICULIER : peut lire ses propres factures (via userId direct)
 * - Les factures PAID ne peuvent plus √™tre modifi√©es
 *
 * PROPRI√âT√â HYBRIDE :
 * - Si companyId != null : la facture appartient √† la company
 * - Si companyId == null : la facture appartient directement au userId
 */
model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PROPRI√âT√â HYBRIDE (Company ou User direct)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Company (NULL si particulier sans entreprise)
  companyId     String?
  company       Company?      @relation(fields: [companyId], references: [id])

  // Propri√©taire direct (pour particuliers sans company)
  userId        String?
  user          User?         @relation("UserInvoices", fields: [userId], references: [id])
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  paidDate      DateTime?
  subtotal      Float
  taxRate       Float         @default(0)
  taxAmount     Float
  discount      Float         @default(0)
  total         Float
  currency      String        @default("EUR")
  status        InvoiceStatus @default(DRAFT)
  paymentMethod String?
  shipment      Shipment?
  quoteId       String?
  quote         Quote?        @relation(fields: [quoteId], references: [id])
  notes         String?
  createdById   String
  createdBy     User          @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  items         InvoiceItem[]
  documents     Document[]

  // üîê Access Policies

  // Les admins et finance managers peuvent tout faire
  @@allow('all', auth().role == ADMIN || auth().role == FINANCE_MANAGER)

  // Les operations managers peuvent lire
  @@allow('read', auth().role == OPERATIONS_MANAGER)

  // PROPRI√âT√â HYBRIDE - Lecture par company
  // Les clients peuvent lire les factures de leur company
  @@allow('read', companyId != null && auth().companyId == companyId && auth().role == CLIENT)

  // PROPRI√âT√â HYBRIDE - Lecture par userId (particuliers sans company)
  // Le propri√©taire direct peut lire ses factures
  @@allow('read', companyId == null && userId != null && auth().id == userId)

  // Les factures pay√©es ne peuvent plus √™tre modifi√©es (r√®gle de s√©curit√©)
  @@deny('update,delete', status == PAID)

  @@deny('all', true)

  @@index([companyId])
  @@index([userId])           // Index pour propri√©t√© hybride
  @@index([status])
  @@index([invoiceNumber])
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

/**
 * Mod√®le InvoiceItem (Lignes de facture)
 * - H√©rite des permissions de l'Invoice parent
 */
model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Float
  unitPrice   Float
  amount      Float

  // üîê Access Policies (h√©rite de Invoice)

  @@allow('all', auth().role == ADMIN || auth().role == FINANCE_MANAGER)
  @@allow('read', auth().role == OPERATIONS_MANAGER)

  // PROPRI√âT√â HYBRIDE - Lecture par company
  @@allow('read', invoice.companyId != null && auth().companyId == invoice.companyId)

  // PROPRI√âT√â HYBRIDE - Lecture par userId (particuliers sans company)
  @@allow('read', invoice.companyId == null && invoice.userId != null && auth().id == invoice.userId)

  @@deny('all', invoice.status == PAID) // Ne peut pas modifier si facture pay√©e
  @@deny('all', true)

  @@index([invoiceId])
}

// ============================================
// DEVIS
// ============================================

/**
 * Mod√®le Quote (Devis)
 * - ADMIN/OPERATIONS_MANAGER : peuvent cr√©er et g√©rer tous les devis
 * - FINANCE_MANAGER : peut lire tous les devis
 * - CLIENT : peut lire et demander des devis pour sa company
 */
model Quote {
  id                 String          @id @default(cuid())
  quoteNumber        String          @unique

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CHAMPS POUR CR√âATION SANS COMPTE (Pattern PickupRequest)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Token unique pour suivi public (validit√© 72h)
  trackingToken      String          @unique @default(cuid())
  tokenExpiresAt     DateTime                              // Expire apr√®s 72h

  // Lien vers l'utilisateur (NULL si cr√©√© sans compte)
  userId             String?
  user               User?           @relation("UserQuotes", fields: [userId], references: [id])

  // Flag indiquant si le devis a √©t√© rattach√© √† un compte
  isAttachedToAccount Boolean        @default(false)

  // Informations de contact pour matching lors de l'inscription
  contactEmail       String                                // Email pour matching
  contactPhone       String?                               // T√©l√©phone pour matching
  contactName        String?                               // Nom du demandeur

  // Company (NULL si cr√©√© sans compte, rempli apr√®s rattachement)
  companyId          String?
  company            Company?        @relation(fields: [companyId], references: [id])

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CHAMPS M√âTIER DU DEVIS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  originCountry      String
  destinationCountry String
  transportMode      TransportMode[]
  cargoType          CargoType
  weight             Float

  // Dimensions (optionnelles) - Volume calcul√© = L √ó W √ó H
  // Champs nullable car optionnels dans le formulaire
  length             Float?           // Longueur en m√®tres
  width              Float?           // Largeur en m√®tres
  height             Float?           // Hauteur en m√®tres

  estimatedCost      Float
  validUntil         DateTime
  currency           String          @default("EUR")
  status             QuoteStatus     @default(DRAFT)
  acceptedAt         DateTime?
  rejectedAt         DateTime?

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CHAMPS WORKFLOW AGENT (Traitement des devis)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // M√©thode de paiement choisie par l'agent lors du traitement
  // Valeurs : CASH (Comptant), ON_DELIVERY (√Ä la livraison), BANK_TRANSFER (Virement)
  paymentMethod        QuotePaymentMethod?

  // Commentaire optionnel de l'agent lors du traitement
  agentComment         String?

  // Date de d√©but du traitement (passage √† IN_TREATMENT)
  treatmentStartedAt   DateTime?

  // Date de validation du traitement (passage √† VALIDATED)
  treatmentValidatedAt DateTime?

  // ID de l'agent qui a trait√© le devis
  treatmentAgentId     String?
  treatmentAgent       User?           @relation("QuoteTreatmentAgent", fields: [treatmentAgentId], references: [id])

  // Date d'annulation et raison (si statut CANCELLED)
  cancelledAt          DateTime?
  cancelReason         String?

  // Relation vers l'exp√©dition cr√©√©e lors de la validation
  shipmentId           String?         @unique
  shipment             Shipment?       @relation("QuoteToShipment", fields: [shipmentId], references: [id])

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // ID de l'utilisateur qui a cr√©√© le devis (NULL si cr√©√© sans compte)
  createdById        String?
  createdBy          User?           @relation("CreatedQuotes", fields: [createdById], references: [id])

  invoices           Invoice[]
  documents          Document[]
  convertedFromGuest GuestQuote?     @relation("ConvertedFromGuest") // Relation inverse pour conversion
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // üîê Access Policies

  // Cr√©ation publique autoris√©e (formulaire sans connexion)
  // Note: Le suivi par token est g√©r√© hors Zenstack (client prisma standard)
  @@allow('create', true)

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent cr√©er, lire et modifier
  @@allow('create,read,update', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Les clients peuvent lire et cr√©er des quotes pour leur company
  @@allow('read,create', auth().companyId == companyId && auth().role == CLIENT)

  // Le propri√©taire peut lire et modifier son devis (si rattach√© √† un compte)
  @@allow('read,update', userId != null && auth().id == userId)

  @@deny('all', true)

  @@index([companyId])
  @@index([status])
  @@index([trackingToken])
  @@index([contactEmail])
  @@index([userId])
}

enum QuoteStatus {
  DRAFT          // Brouillon - devis en cours de cr√©ation
  SENT           // Envoy√© - devis envoy√© au client, en attente de r√©ponse
  ACCEPTED       // Accept√© - le client a accept√© le devis
  REJECTED       // Rejet√© - le client a refus√© le devis
  EXPIRED        // Expir√© - date de validit√© d√©pass√©e
  IN_TREATMENT   // En traitement - un agent traite le devis (apr√®s acceptation client)
  VALIDATED      // Valid√© - traitement termin√© par l'agent, colis cr√©√©
  CANCELLED      // Annul√© - devis annul√© par l'agent
}

/**
 * M√©thode de paiement choisie lors du traitement d'un devis
 * Utilis√© par l'agent lors du workflow de traitement
 */
enum QuotePaymentMethod {
  CASH           // Comptant - paiement imm√©diat
  ON_DELIVERY    // √Ä la livraison - paiement √† la r√©ception
  BANK_TRANSFER  // Virement bancaire - envoi du RIB au client
}

enum ProspectStatus {
  PENDING      // En attente de finalisation d'inscription
  CONVERTED    // Converti en User
  EXPIRED      // Token d'invitation expir√©
}

// ============================================
// PROSPECTS ET GUEST QUOTES
// ============================================

/**
 * Mod√®le Prospect
 * Repr√©sente une personne qui a demand√© un devis sans cr√©er de compte complet
 *
 * Workflow :
 * 1. Utilisateur non-connect√© demande un devis ‚Üí Cr√©ation Prospect + GuestQuote
 * 2. Email envoy√© avec PDF + lien invitation (token valide 7 jours)
 * 3. Prospect clique sur le lien ‚Üí Finalise inscription ‚Üí Conversion en User
 * 4. GuestQuotes convertis en Quotes li√©s √† la Company du User
 *
 * Access policies :
 * - Lecture publique (pour v√©rification du token)
 * - Cr√©ation publique (calculateur accessible √† tous)
 * - Modification/suppression r√©serv√©e aux ADMIN
 */
model Prospect {
  id                    String         @id @default(cuid())
  email                 String         @unique
  phone                 String?
  name                  String?
  company               String?        // Nom entreprise (texte libre, pas li√© √† Company)
  subject               String?        // Objet de la demande de contact

  // Token d'invitation s√©curis√©
  invitationToken       String         @unique @default(cuid())
  invitationExpiresAt   DateTime       // 7 jours apr√®s cr√©ation

  status                ProspectStatus @default(PENDING)

  // Lien vers User si converti
  userId                String?        @unique
  user                  User?          @relation(fields: [userId], references: [id])

  // Relations
  guestQuotes           GuestQuote[]

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  // üîê Access Policies

  // Lecture publique n√©cessaire pour v√©rifier les tokens
  @@allow('read', true)

  // Cr√©ation publique pour le calculateur de devis
  @@allow('create', true)

  // Seuls les admins peuvent modifier ou supprimer
  @@allow('update,delete', auth().role == ADMIN)

  // Par d√©faut, tout est interdit
  @@deny('all', true)

  @@index([email])
  @@index([invitationToken])
  @@index([status])
}

/**
 * Mod√®le GuestQuote (Devis Prospect)
 * Repr√©sente un devis pour un prospect (utilisateur non-connect√©)
 *
 * Diff√©rences avec Quote :
 * - Pas de companyId (li√© √† prospectId)
 * - Num√©ro format GQTE-YYYYMMDD-XXXXX (au lieu de QTE-)
 * - Peut √™tre converti en Quote lors de la cr√©ation du compte
 *
 * Access policies :
 * - Lecture publique (pour afficher dans les emails)
 * - Cr√©ation publique (calculateur)
 * - ADMIN ont acc√®s complet
 */
model GuestQuote {
  id                 String          @id @default(cuid())
  quoteNumber        String          @unique // Format: GQTE-YYYYMMDD-XXXXX

  // Li√© au Prospect (au lieu de Company)
  prospectId         String
  prospect           Prospect        @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  // Champs du devis (identiques √† Quote)
  originCountry      String
  destinationCountry String
  transportMode      TransportMode[]
  cargoType          CargoType
  weight             Float

  // Dimensions (optionnelles) - Volume calcul√© = L √ó W √ó H
  // Champs nullable car optionnels dans le formulaire
  length             Float?           // Longueur en m√®tres
  width              Float?           // Largeur en m√®tres
  height             Float?           // Hauteur en m√®tres

  estimatedCost      Float
  validUntil         DateTime
  currency           String          @default("EUR")

  // Conversion tracking
  convertedToQuoteId String?         @unique
  convertedToQuote   Quote?          @relation("ConvertedFromGuest", fields: [convertedToQuoteId], references: [id])

  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // üîê Access Policies

  // Lecture publique (affichage dans emails)
  @@allow('read', true)

  // Cr√©ation publique (calculateur)
  @@allow('create', true)

  // Les admins ont acc√®s complet
  @@allow('all', auth().role == ADMIN)

  // Par d√©faut, tout est interdit
  @@deny('all', true)

  @@index([prospectId])
  @@index([quoteNumber])
}


// ============================================
// NOTIFICATIONS
// ============================================

/**
 * Mod√®le Notification (Notifications utilisateur)
 * - ADMIN : peut lire et cr√©er toutes les notifications
 * - Chaque user peut lire et modifier ses propres notifications
 */
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Chaque user peut lire et modifier (marquer comme lu) ses propres notifications
  @@allow('read,update', auth().id == userId)

  // Les operations managers peuvent cr√©er des notifications
  @@allow('create', auth().role == OPERATIONS_MANAGER)

  @@deny('all', true)

  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  SHIPMENT_CREATED
  SHIPMENT_PICKED_UP
  SHIPMENT_IN_TRANSIT
  SHIPMENT_DELIVERED
  SHIPMENT_DELAYED
  INVOICE_GENERATED
  INVOICE_PAID
  QUOTE_REQUEST
  CUSTOMS_CLEARED
  DOCUMENT_UPLOADED
}

// ============================================
// GESTION DOCUMENTAIRE
// ============================================

/**
 * Type de document
 */
enum DocumentType {
  INVOICE_SCAN           // Scan de facture
  PROOF_OF_DELIVERY      // Preuve de livraison
  PROOF_OF_PICKUP        // Preuve d'enl√®vement
  PICKUP_SIGNATURE       // Signature d'enl√®vement
  CUSTOMS_DOCUMENT       // Document douanier
  PACKING_LIST           // Liste de colisage
  BILL_OF_LADING         // Connaissement
  CMR                    // Lettre de voiture CMR
  AIRWAY_BILL            // Lettre de transport a√©rien
  CERTIFICATE            // Certificat (origine, conformit√©, etc.)
  PHOTO                  // Photo de la marchandise
  OTHER                  // Autre document
}

/**
 * Mod√®le Document (Gestion documentaire)
 * - ADMIN : acc√®s complet √† tous les documents
 * - OPERATIONS_MANAGER : peut cr√©er, lire et supprimer tous les documents
 * - FINANCE_MANAGER : peut lire tous les documents
 * - CLIENT : peut cr√©er et lire les documents de sa company
 * - PARTICULIER : peut cr√©er et lire ses propres documents (via userId direct)
 * - L'uploader peut supprimer son propre document
 *
 * PROPRI√âT√â HYBRIDE :
 * - Si companyId != null : le document appartient √† la company
 * - Si companyId == null : le document appartient directement au userId
 */
model Document {
  id          String       @id @default(cuid())
  name        String       // Nom du fichier original
  fileUrl     String       // URL du fichier stock√© (UploadThing, S3, etc.)
  fileKey     String       // Cl√© unique du fichier pour suppression
  fileSize    Int          // Taille en octets
  mimeType    String       // Type MIME (application/pdf, image/jpeg, etc.)
  type        DocumentType // Type de document
  description String?      // Description optionnelle

  // Relations (au moins une doit √™tre pr√©sente)
  shipmentId String?
  shipment   Shipment? @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  invoiceId String?
  invoice   Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  quoteId String?
  quote   Quote?    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  pickupRequestId String?
  pickupRequest   PickupRequest? @relation(fields: [pickupRequestId], references: [id], onDelete: Cascade)

  purchaseRequestId String?
  purchaseRequest   PurchaseRequest? @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PROPRI√âT√â HYBRIDE (Company ou User direct)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Company (NULL si particulier sans entreprise)
  companyId   String?
  company     Company?  @relation(fields: [companyId], references: [id])

  // Propri√©taire direct (pour particuliers sans company)
  userId      String?
  user        User?     @relation("UserDocuments", fields: [userId], references: [id])

  // Uploader du document (peut √™tre diff√©rent du propri√©taire)
  uploadedBy  String
  uploader    User     @relation("UploadedDocuments", fields: [uploadedBy], references: [id])
  uploadedAt  DateTime @default(now())

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent cr√©er, lire et supprimer
  @@allow('create,read,delete', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire tous les documents
  @@allow('read', auth().role == FINANCE_MANAGER)

  // PROPRI√âT√â HYBRIDE - Lecture par company
  // Les clients peuvent cr√©er et lire les documents de leur company
  @@allow('create,read', companyId != null && auth().companyId == companyId && auth().role == CLIENT)

  // PROPRI√âT√â HYBRIDE - Lecture par userId (particuliers sans company)
  // Le propri√©taire direct peut cr√©er et lire ses documents
  @@allow('create,read', companyId == null && userId != null && auth().id == userId)

  // L'uploader peut supprimer son propre document
  @@allow('delete', auth().id == uploadedBy)

  @@deny('all', true)

  @@index([companyId])
  @@index([userId])           // Index pour propri√©t√© hybride
  @@index([shipmentId])
  @@index([invoiceId])
  @@index([quoteId])
  @@index([pickupRequestId])
  @@index([purchaseRequestId])
  @@index([uploadedBy])
}

// ============================================
// TRANSPORTEURS
// ============================================

/**
 * Type de transporteur
 */
enum TransporterType {
  ROAD        // Routier
  SEA         // Maritime
  AIR         // A√©rien
  RAIL        // Ferroviaire
  MULTIMODAL  // Multimodal
}

/**
 * Mod√®le Transporter (Transporteurs/Partenaires de transport)
 * - ADMIN : acc√®s complet
 * - OPERATIONS_MANAGER : peut cr√©er, lire et modifier tous les transporteurs
 * - FINANCE_MANAGER : peut lire tous les transporteurs
 * - CLIENT/VIEWER : peuvent voir les transporteurs actifs
 */
model Transporter {
  id            String          @id @default(cuid())
  name          String          // Nom du transporteur
  type          TransporterType // Type de transport
  email         String          @unique
  phone         String
  address       String?
  city          String?
  postalCode    String?
  country       String?
  website       String?

  // Informations commerciales
  contactPerson String? // Nom du contact principal
  taxId         String? // Num√©ro de TVA
  iban          String? // IBAN pour les paiements

  // M√©tadonn√©es
  notes    String?  // Notes internes
  isActive Boolean  @default(true) // Transporteur actif ou non
  rating   Float?   @default(0) // Note de 0 √† 5

  // Relations
  companyId      String
  company        Company @relation(fields: [companyId], references: [id])
  pickupRequests PickupRequest[] // Enl√®vements assign√©s √† ce transporteur

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîê Access Policies

  // Les admins peuvent tout faire
  @@allow('all', auth().role == ADMIN)

  // Les operations managers peuvent cr√©er, lire et modifier
  @@allow('create,read,update', auth().role == OPERATIONS_MANAGER)

  // Les finance managers peuvent lire
  @@allow('read', auth().role == FINANCE_MANAGER)

  // Les clients peuvent voir les transporteurs actifs
  @@allow('read', isActive == true && (auth().role == CLIENT || auth().role == VIEWER))

  @@deny('all', true)

  @@index([companyId])
  @@index([type])
  @@map("transporter")
}

// ============================================
// CONFIGURATION DES PRIX
// ============================================

/**
 * Mod√®le PricingConfig (Configuration globale des prix)
 *
 * Stocke tous les param√®tres de tarification utilis√©s dans le calcul des devis.
 * Il ne doit exister qu'une seule instance de ce mod√®le (singleton).
 *
 * Structure des champs JSON :
 * - transportMultipliers : { ROAD: 1.0, SEA: 0.6, AIR: 3.0, RAIL: 0.8 }
 * - cargoTypeSurcharges : { GENERAL: 0, DANGEROUS: 0.5, PERISHABLE: 0.4, ... }
 * - prioritySurcharges : { STANDARD: 0, NORMAL: 0.1, EXPRESS: 0.5, URGENT: 0.3 }
 * - deliverySpeedsPerMode : {
 *     ROAD: { min: 3, max: 7 },
 *     SEA: { min: 20, max: 45 },
 *     AIR: { min: 1, max: 3 },
 *     RAIL: { min: 7, max: 14 }
 *   }
 * - volumetricWeightRatios : { AIR: 167, ROAD: 333, SEA: 1, RAIL: 250 }
 *   ‚Üí D√©finit combien de kg √©quivaut 1 m¬≥ pour chaque mode
 *   ‚Üí Bas√© sur les ratios du PDF : AIR (1/6 = 6000), ROAD (1/3 = 5000), SEA (1/1 = 1000)
 * - useVolumetricWeightPerMode : { AIR: true, ROAD: true, SEA: false, RAIL: true }
 *   ‚Üí Active/d√©sactive le poids volum√©trique par mode
 *   ‚Üí Maritime (SEA) utilise "Poids ou Mesure" (Unit√© Payante) au lieu du poids volum√©trique
 *
 * Access policies :
 * - ADMIN uniquement pour toutes les op√©rations
 */
model PricingConfig {
  id                   String   @id @default(cuid())

  // Taux de base
  baseRatePerKg        Float    @default(0.5) // ‚Ç¨ par kg (ANCIEN - conserv√© pour compatibilit√©)

  // NOUVEAUX : Tarifs par d√©faut pour fallback (si route non configur√©e dans matrice)
  defaultRatePerKg     Float    @default(1.0)   // ‚Ç¨ par kg
  defaultRatePerM3     Float    @default(200.0) // ‚Ç¨ par m¬≥

  // Multiplicateurs par mode de transport (utilis√©s uniquement si route non configur√©e)
  transportMultipliers Json     // { ROAD: Float, SEA: Float, AIR: Float, RAIL: Float }

  // Surcharges par type de cargo (coefficients multiplicateurs, ex: DANGEROUS: 0.5 = +50%)
  cargoTypeSurcharges  Json     // { GENERAL: Float, DANGEROUS: Float, PERISHABLE: Float, ... }

  // Surcharges par priorit√© (coefficients multiplicateurs, ex: NORMAL: 0.1 = +10%)
  prioritySurcharges   Json     // { STANDARD: Float, NORMAL: Float, EXPRESS: Float, URGENT: Float }

  // D√©lais de livraison par mode (en jours)
  deliverySpeedsPerMode Json    // { ROAD: {min, max}, SEA: {min, max}, ... }

  // === NOUVEAUX CHAMPS POUR ALGORITHME PDF ===

  // Ratios de conversion poids volum√©trique : combien de kg = 1 m¬≥
  // Exemple : { AIR: 167, ROAD: 333, SEA: 1, RAIL: 250 }
  // AIR: 167 signifie que 1 m¬≥ = 167 kg (ratio 1/6 = 6000)
  // ROAD: 333 signifie que 1 m¬≥ = 333 kg (ratio 1/3 = 5000)
  // SEA: 1 signifie que 1 m¬≥ = 1 tonne (ratio 1/1 = 1000)
  volumetricWeightRatios Json @default("{\"AIR\":167,\"ROAD\":333,\"SEA\":1,\"RAIL\":250}")

  // Activation du poids volum√©trique par mode de transport
  // Exemple : { AIR: true, ROAD: true, SEA: false, RAIL: true }
  // SEA: false car le maritime utilise "Poids ou Mesure" (Unit√© Payante)
  useVolumetricWeightPerMode Json @default("{\"AIR\":true,\"ROAD\":true,\"SEA\":false,\"RAIL\":true}")

  // M√©tadonn√©es
  updatedById          String
  updatedBy            User     @relation(fields: [updatedById], references: [id])
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // üîê Access Policies

  // Seuls les admins peuvent g√©rer la configuration des prix
  @@allow('all', auth().role == ADMIN)

  @@deny('all', true)

  @@map("pricing_config")
}

/**
 * Mod√®le CountryDistance (Distances entre pays)
 *
 * Table de r√©f√©rence des distances en kilom√®tres entre les pays.
 * Utilis√©e dans le calcul du facteur de distance pour les devis.
 *
 * Contraintes :
 * - Chaque paire (originCountry, destinationCountry) doit √™tre unique
 * - Les distances sont bidirectionnelles (FR->DE = DE->FR)
 *
 * Access policies :
 * - Lecture publique (n√©cessaire pour le calcul des devis publics)
 * - Cr√©ation/Modification/Suppression : ADMIN uniquement
 */
model CountryDistance {
  id                 String   @id @default(cuid())
  originCountry      String   // Code pays ISO (ex: "FR", "DE", "ES")
  destinationCountry String   // Code pays ISO
  distanceKm         Int      // Distance en kilom√®tres

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // üîê Access Policies

  // Lecture publique n√©cessaire pour calcul des devis
  @@allow('read', true)

  // Seuls les admins peuvent cr√©er, modifier ou supprimer
  @@allow('create,update,delete', auth().role == ADMIN)

  @@deny('all', true)

  @@unique([originCountry, destinationCountry])
  @@index([originCountry])
  @@index([destinationCountry])
  @@map("country_distance")
}

/**
 * Mod√®le TransportRate (Tarifs de Transport par Route)
 *
 * Stocke les tarifs sp√©cifiques pour chaque combinaison origine-destination-mode.
 * Permet une tarification granulaire avec des surcharges personnalis√©es par route.
 *
 * Structure :
 * - Cl√© unique : (originCountryCode, destinationCountryCode, transportMode)
 * - Tarifs : ratePerKg (‚Ç¨/kg) et ratePerM3 (‚Ç¨/m¬≥)
 * - Surcharges optionnelles : JSON pour cargo et priorit√©
 *
 * Logique de calcul :
 * 1. prixBase = MAX(poids √ó ratePerKg, volume √ó ratePerM3)
 * 2. Appliquer surcharges cargo de la route (ou fallback PricingConfig)
 * 3. Appliquer surcharges priorit√© de la route (ou fallback PricingConfig)
 *
 * Access policies :
 * - Lecture publique (n√©cessaire pour calcul des devis publics)
 * - Cr√©ation/Modification/Suppression : ADMIN uniquement
 */
model TransportRate {
  id                     String        @id @default(cuid())

  // Cl√© de route
  originCountryCode      String        // Code pays ISO (ex: "FR")
  destinationCountryCode String        // Code pays ISO (ex: "BF")
  transportMode          TransportMode // ROAD | SEA | AIR | RAIL

  // Tarifs de base (requis)
  ratePerKg              Float         // Tarif en ‚Ç¨/kg
  ratePerM3              Float         // Tarif en ‚Ç¨/m¬≥

  // Surcharges personnalis√©es (optionnelles, JSON)
  // Si null, utilise les surcharges globales de PricingConfig
  cargoTypeSurcharges    Json?         // { GENERAL: 0, DANGEROUS: 0.3, ... }
  prioritySurcharges     Json?         // { STANDARD: 0, EXPRESS: 0.5, ... }

  // M√©tadonn√©es
  isActive               Boolean       @default(true) // Permet de d√©sactiver une route
  notes                  String?       // Notes internes
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // üîê Access Policies

  // Lecture publique n√©cessaire pour calcul des devis
  @@allow('read', true)

  // Seuls les admins peuvent cr√©er, modifier ou supprimer
  @@allow('all', auth().role == ADMIN)

  // Index et contraintes
  @@unique([originCountryCode, destinationCountryCode, transportMode])
  @@index([originCountryCode])
  @@index([destinationCountryCode])
  @@index([transportMode])
  @@index([isActive])
  @@map("transport_rate")
}

// ============================================
// GESTION DES PAYS
// ============================================

/**
 * Mod√®le Country (Pays)
 *
 * Table de r√©f√©rence des pays disponibles pour les exp√©ditions.
 * Utilis√©e pour les s√©lecteurs de pays d'origine et de destination.
 *
 * Structure :
 * - code : Code ISO 3166-1 alpha-2 (ex: "FR", "DE", "US")
 * - name : Nom du pays en fran√ßais (ex: "France", "Allemagne", "√âtats-Unis")
 * - isActive : Indique si le pays est actif pour les exp√©ditions
 *
 * Access policies :
 * - Lecture publique (n√©cessaire pour les formulaires de devis publics)
 * - Cr√©ation/Modification/Suppression : ADMIN uniquement
 */
model Country {
  id        String   @id @default(cuid())
  code      String   @unique // Code ISO 3166-1 alpha-2 (ex: "FR", "DE")
  name      String   // Nom en fran√ßais (ex: "France", "Allemagne")
  isActive  Boolean  @default(true) // Pays activ√© pour les exp√©ditions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîê Access Policies

  // Lecture publique n√©cessaire pour les formulaires de devis
  @@allow('read', true)

  // Seuls les admins peuvent cr√©er, modifier ou supprimer
  @@allow('create,update,delete', auth().role == ADMIN)

  // Par d√©faut, refuser ce qui n'est pas explicitement autoris√©
  // Note: Ne pas utiliser @@deny('all', true) car cela bloquerait m√™me les @@allow ci-dessus
  @@deny('all', auth() == null)

  @@index([code])
  @@index([isActive])
  @@map("country")
}
