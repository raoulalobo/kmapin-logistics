Impl√©mentation d'un syst√®me de devis en deux modes (calculateur interactif + tableau de tarifs standards) avec
 gestion compl√®te des prospects (utilisateurs non-connect√©s) et workflow de conversion vers utilisateurs
 authentifi√©s.

 Fonctionnalit√©s cl√©s :
 - ‚úÖ Deux modes d'acc√®s : "Faire un devis" (calculateur) et "Consulter les prix standard" (tableau interactif)
 - ‚úÖ Utilisateurs connect√©s : t√©l√©chargement PDF + sauvegarde dans l'espace client
 - ‚úÖ Utilisateurs non-connect√©s : r√©ception par email OU cr√©ation de compte
 - ‚úÖ Syst√®me de prospects avec token d'invitation (validit√© 7 jours)
 - ‚úÖ Workflow de conversion : prospect ‚Üí utilisateur avec rattachement automatique des devis
 - ‚úÖ Envoi d'emails via Resend (devis PDF, invitation, bienvenue)
 - ‚úÖ Jobs Inngest pour expiration et rappels automatiques

 Choix de conception valid√©s :
 - Format tarifs : Tableau interactif avec filtres et bouton "Utiliser ce mode"
 - Infos prospects : Email + T√©l√©phone (obligatoires)
 - Validit√© lien : 7 jours
 - Emails : Resend (impl√©mentation imm√©diate)

 ---
 üóÑÔ∏è 1. Modifications du Sch√©ma de Base de Donn√©e

 Fichier : schema.zmodel

 1.1 Nouvel Enum ProspectStatus

 enum ProspectStatus {
   PENDING      // En attente de finalisation
   CONVERTED    // Converti en User
   EXPIRED      // Token expir√©
 }

 1.2 Nouveau Mod√®le Prospect

 model Prospect {
   id                    String         @id @default(cuid())
   email                 String         @unique
   phone                 String?
   name                  String?
   company               String?        // Texte libre, pas li√© √† Company

   // Token d'invitation
   invitationToken       String         @unique @default(cuid())
   invitationExpiresAt   DateTime       // 7 jours apr√®s cr√©ation

   status                ProspectStatus @default(PENDING)

   // Conversion
   userId                String?        @unique
   user                  User?          @relation(fields: [userId], references: [id])

   // Relations
   guestQuotes           GuestQuote[]

   createdAt             DateTime       @default(now())
   updatedAt             DateTime       @updatedAt

   // Access Policies
   @@allow('read', true)                           // Lecture publique (token verification)
   @@allow('create', true)                         // Cr√©ation publique (calculateur)
   @@allow('update,delete', auth().role == ADMIN)
   @@deny('all', true)

   @@index([email])
   @@index([invitationToken])
   @@index([status])
 }

 1.3 Nouveau Mod√®le GuestQuote

 model GuestQuote {
   id                 String          @id @default(cuid())
   quoteNumber        String          @unique // Format: GQTE-YYYYMMDD-XXXXX

   // Li√© au Prospect
   prospectId         String
   prospect           Prospect        @relation(fields: [prospectId], references: [id], onDelete: Cascade)

   // Champs du devis
   originCountry      String
   destinationCountry String
   transportMode      TransportMode[]
   cargoType          CargoType
   weight             Float
   volume             Float?
   estimatedCost      Float
   validUntil         DateTime
   currency           String          @default("EUR")

   // Conversion tracking
   convertedToQuoteId String?         @unique
   convertedToQuote   Quote?          @relation("ConvertedFromGuest", fields: [convertedToQuoteId], references:
 [id])

   createdAt          DateTime        @default(now())
   updatedAt          DateTime        @updatedAt

   // Access Policies
   @@allow('read', true)
   @@allow('create', true)
   @@allow('all', auth().role == ADMIN)
   @@deny('all', true)

   @@index([prospectId])
   @@index([quoteNumber])
 }

 1.4 Modifications des Mod√®les Existants

 User : Ajouter prospect Prospect? (relation 1:1)

 Quote : Ajouter convertedFromGuest GuestQuote? @relation("ConvertedFromGuest") (relation inverse)

 1.5 Commandes apr√®s modification

 npm run db:generate
 npm run db:push

 ---
 üì¶ 2. Nouveaux Modules Backend

 2.1 Module prospects

 Structure :
 src/modules/prospects/
 ‚îú‚îÄ‚îÄ actions/
 ‚îÇ   ‚îî‚îÄ‚îÄ prospect.actions.ts
 ‚îú‚îÄ‚îÄ schemas/
 ‚îÇ   ‚îî‚îÄ‚îÄ prospect.schema.ts
 ‚îî‚îÄ‚îÄ index.ts

 Actions principales :

 1. createProspectAndSendQuoteAction(data)
   - Cr√©er/r√©utiliser Prospect (si email existe et EXPIRED ‚Üí nouveau token)
   - G√©n√©rer GuestQuote avec num√©ro GQTE-YYYYMMDD-XXXXX
   - G√©n√©rer PDF du devis
   - Envoyer email avec PDF + lien invitation
   - Important : Utiliser prisma standard (pas enhanced, action publique)
 2. getProspectByTokenAction(token)
   - R√©cup√©rer prospect avec v√©rification d'expiration
   - Inclure guestQuotes
   - Action publique
 3. getProspectByEmailAction(email)
   - V√©rifier si User existe avec cet email
   - Retourner { userExists: boolean }
 4. completeRegistrationAction(token, formData)
   - Valider token non expir√©
   - Cr√©er Company par d√©faut pour le prospect
   - Retourner donn√©es pour cr√©ation User (c√¥t√© client Better Auth)
 5. finalizeProspectConversionAction(prospectId, userId)
   - Convertir tous les GuestQuotes en Quotes
   - Lier √† la Company du User
   - Mettre √† jour Prospect : status = CONVERTED, userId
   - D√©clencher √©v√©nement Inngest prospect/converted
 6. attachProspectToExistingUserAction(token, password)
   - Valider token
   - Retourner infos pour authentification
   - (Auth + conversion se font c√¥t√© client/autre action)

 Sch√©mas Zod :
 - prospectSchema : email, phone, name?, company?, quoteData
 - completeRegistrationSchema : password, name, phone, country
 - attachToAccountSchema : password

 2.2 Module guest-quotes

 Structure :
 src/modules/guest-quotes/
 ‚îú‚îÄ‚îÄ actions/
 ‚îÇ   ‚îî‚îÄ‚îÄ guest-quote.actions.ts
 ‚îú‚îÄ‚îÄ schemas/
 ‚îÇ   ‚îî‚îÄ‚îÄ guest-quote.schema.ts
 ‚îî‚îÄ‚îÄ index.ts

 Actions :
 - createGuestQuoteAction(prospectId, quoteData) : Cr√©er GuestQuote
 - getGuestQuoteAction(id) : R√©cup√©rer un GuestQuote (public)
 - convertGuestQuoteToQuoteAction(guestQuoteId, companyId) : Conversion vers Quote

 2.3 Module pricing

 Structure :
 src/modules/pricing/
 ‚îú‚îÄ‚îÄ actions/
 ‚îÇ   ‚îî‚îÄ‚îÄ pricing.actions.ts
 ‚îú‚îÄ‚îÄ schemas/
 ‚îÇ   ‚îî‚îÄ‚îÄ pricing.schema.ts
 ‚îú‚îÄ‚îÄ data/
 ‚îÇ   ‚îî‚îÄ‚îÄ standard-rates.ts
 ‚îî‚îÄ‚îÄ index.ts

 Donn√©es (standard-rates.ts) :
 export const STANDARD_RATES: StandardRate[] = [
   {
     id: 'eu-de-road',
     destination: 'Allemagne',
     destinationCode: 'DE',
     transportMode: 'ROAD',
     cargoType: 'GENERAL',
     pricePerKg: 0.45,
     minPrice: 200,
     maxPrice: 2000,
     estimatedDaysMin: 2,
     estimatedDaysMax: 4,
     currency: 'EUR',
   },
   // ... autres destinations (France, Belgique, Espagne, Italie, UK, etc.)
 ];

 Actions :
 - getStandardRatesAction(filters?) : R√©cup√©rer tarifs avec filtres (destination, mode transport, search)

 ---
 üìß 3. Configuration Resend et Templates Email

 3.1 Installation

 npm install resend

 3.2 Configuration

 Fichier : src/lib/email/resend.ts

 import { Resend } from 'resend';

 export const resend = new Resend(process.env.RESEND_API_KEY);

 export const EMAIL_CONFIG = {
   from: 'Faso Fret Logistics <noreply@kmapin.com>',
   replyTo: 'support@kmapin.com',
 };

 export async function sendEmail(params: {
   to: string;
   subject: string;
   html: string;
   attachments?: Array<{ filename: string; content: Buffer }>;
 }) {
   // Logique d'envoi avec gestion dev/prod
   const emailProvider = process.env.EMAIL_PROVIDER || 'console';

   if (emailProvider === 'console') {
     console.log('üìß Email simul√©:', params.to, params.subject);
     return { success: true };
   }

   const result = await resend.emails.send({
     from: EMAIL_CONFIG.from,
     replyTo: EMAIL_CONFIG.replyTo,
     ...params,
   });

   return { success: true, data: result };
 }

 Variables d'environnement (.env) :
 RESEND_API_KEY="re_xxxxxxxxxxxxx"
 EMAIL_PROVIDER="console"  # En dev, "resend" en prod

 3.3 Templates

 Fichiers √† cr√©er :
 - src/lib/email/templates/quote-pdf.ts : Email avec devis PDF + lien invitation
 - src/lib/email/templates/invitation.ts : Rappel invitation (J-3)
 - src/lib/email/templates/welcome.ts : Bienvenue apr√®s cr√©ation compte

 Structure template :
 - HTML responsive avec gradient bleu (#0033FF)
 - Logo Faso Fret Logistics
 - R√©sum√© du devis
 - CTA "Cr√©er mon compte gratuitement" (lien avec token)
 - Footer avec mentions

 ---
 üìÑ 4. G√©n√©ration PDF pour GuestQuote

 Fichier : src/lib/pdf/guest-quote-pdf.ts

 export function generateGuestQuotePDF(data: GuestQuotePDFData): Buffer {
   // Similaire √† quote-pdf.ts mais avec :
   // - Format GQTE-YYYYMMDD-XXXXX
   // - Infos prospect (email, phone, name?, company?)
   // - Note "Estimation indicative" en encadr√© jaune
   // - Message "Cr√©ez un compte pour devis officiel"
 }

 ---
 ‚öôÔ∏è 5. Jobs Inngest

 Fichier : src/lib/inngest/functions/prospects.ts

 5.1 Job : markExpiredProspects

 - Cron : 0 2 * * * (2h00 quotidien)
 - Action : Marquer prospects avec invitationExpiresAt < now en EXPIRED

 5.2 Job : sendProspectReminders

 - Cron : 0 10 * * * (10h00 quotidien)
 - Action : Envoyer rappels aux prospects expirant dans 3 jours

 5.3 Event : onProspectConverted

 - Event : prospect/converted
 - Action : Envoyer email de bienvenue avec nombre de devis rattach√©s

 Mise √† jour client Inngest :
 - Ajouter √©v√©nement prospect/converted dans src/lib/inngest/client.ts
 - Exporter jobs dans src/lib/inngest/index.ts

 ---
 üé® 6. Composants React

 6.1 QuoteRequestModal

 Fichier : src/components/quote-request/quote-request-modal.tsx

 - Dialog pour demander email + t√©l√©phone + nom? + entreprise?
 - Validation avec React Hook Form + Zod
 - Appel √† createProspectAndSendQuoteAction
 - Message de succ√®s : "Devis envoy√© ! Consultez votre email"

 6.2 Modification de QuoteCalculator

 Fichier : src/components/quote-calculator/quote-calculator.tsx

 Ajouts apr√®s affichage du r√©sultat :

 // Boutons selon √©tat connexion
 {session?.user ? (
   <>
     <Button onClick={handleDownloadPDF}>T√©l√©charger PDF</Button>
     <Button onClick={handleSaveQuote}>Sauvegarder dans mon espace</Button>
   </>
 ) : (
   <>
     <Button onClick={handleDownloadPDF}>T√©l√©charger PDF</Button>
     <Button onClick={() => setShowEmailModal(true)}>Recevoir par email</Button>
     <Button variant="outline" asChild>
       <Link href="/register">Cr√©er un compte</Link>
     </Button>
   </>
 )}

 <QuoteRequestModal open={showEmailModal} onClose={...} quoteData={...} />

 6.3 PricingTable

 Fichier : src/components/pricing-table/pricing-table.tsx

 - Tableau avec colonnes : Destination, Mode transport, Prix estim√©, D√©lai
 - Filtres : Search destination + Select mode transport
 - Bouton "Utiliser ce mode" ‚Üí Redirige vers /#calculateur?destination=XX&mode=XX
 - useQuery avec TanStack Query pour charger getStandardRatesAction

 6.4 CompleteRegistrationForm

 Fichier : src/components/registration/complete-registration-form.tsx

 Workflow :
 1. useEffect : Charger prospect par token
 2. V√©rifier si email existe d√©j√† ‚Üí getProspectByEmailAction
 3. Cas A (email nouveau) :
   - Formulaire : password, name (pr√©-rempli), phone (pr√©-rempli), country
   - Submit ‚Üí completeRegistrationAction + signUp.email (Better Auth) + finalizeProspectConversionAction
 4. Cas B (email existe) :
   - Afficher AttachToAccountForm

 6.5 AttachToAccountForm

 Fichier : src/components/registration/attach-to-account-form.tsx

 - Message : "Vous avez d√©j√† un compte !"
 - Formulaire : email (disabled), password, lien "Mot de passe oubli√© ?"
 - Submit ‚Üí attachProspectToExistingUserAction + signIn.email (Better Auth) + finalizeProspectConversionAction

 ---
 üåê 7. Pages et Routes

 7.1 Page Tarifs

 Fichier : src/app/(public)/tarifs/page.tsx

 - Titre : "Tarifs Standards - Transport International"
 - Description : "Consultez nos tarifs indicatifs..."
 - Composant : <PricingTable />

 7.2 Page Finalisation d'Inscription

 Fichier : src/app/(public)/complete-registration/page.tsx

 - R√©cup√©rer token depuis searchParams
 - Client Component avec Suspense
 - Composant : <CompleteRegistrationForm token={token} />

 7.3 Modification Homepage

 Fichier : src/app/page.tsx

 Ajouts :
 - Hero section avec deux CTA :
   - "Faire un devis" ‚Üí #calculateur
   - "Consulter les prix standard" ‚Üí /tarifs
 - Section calculateur avec id="calculateur" (ancre)

 ---
 üìã 8. Ordre d'Impl√©mentation Recommand√©

 Phase 1 : Fondations (1-2h)

 1. ‚úÖ Modifier schema.zmodel (ProspectStatus, Prospect, GuestQuote, relations)
 2. ‚úÖ npm run db:generate && npm run db:push
 3. ‚úÖ npm install resend
 4. ‚úÖ Cr√©er src/lib/email/resend.ts
 5. ‚úÖ Ajouter RESEND_API_KEY et EMAIL_PROVIDER dans .env

 Phase 2 : Modules Core (3-4h)

 6. ‚úÖ Cr√©er module prospects (schemas + actions)
 7. ‚úÖ Cr√©er module guest-quotes (schemas + actions)
 8. ‚úÖ Cr√©er module pricing (data + actions)
 9. ‚úÖ Cr√©er src/lib/pdf/guest-quote-pdf.ts
 10. ‚úÖ Cr√©er templates email (quote-pdf, invitation, welcome)

 Phase 3 : Jobs Inngest (2h)

 11. ‚úÖ Cr√©er src/lib/inngest/functions/prospects.ts
 12. ‚úÖ Mettre √† jour src/lib/inngest/client.ts (event)
 13. ‚úÖ Tester avec npx inngest-cli@latest dev

 Phase 4 : Composants UI (4-5h)

 14. ‚úÖ Cr√©er QuoteRequestModal
 15. ‚úÖ Modifier QuoteCalculator (boutons conditionnels)
 16. ‚úÖ Cr√©er PricingTable
 17. ‚úÖ Cr√©er CompleteRegistrationForm
 18. ‚úÖ Cr√©er AttachToAccountForm

 Phase 5 : Pages (2h)

 19. ‚úÖ Cr√©er page /tarifs
 20. ‚úÖ Cr√©er page /complete-registration
 21. ‚úÖ Modifier homepage (hero + CTA)

 Phase 6 : Tests et Validation (3h)

 22. ‚úÖ Tester workflow complet : calculateur ‚Üí email ‚Üí conversion
 23. ‚úÖ Tester jobs Inngest
 24. ‚úÖ V√©rifier access policies Zenstack

 ---
 üéØ Fichiers Critiques √† Modifier/Cr√©er

 √Ä Modifier

 1. schema.zmodel : Ajout Prospect, GuestQuote, ProspectStatus
 2. src/components/quote-calculator/quote-calculator.tsx : Boutons conditionnels + modal
 3. src/app/page.tsx : Hero avec deux CTA
 4. src/lib/inngest/client.ts : √âv√©nement prospect/converted
 5. src/lib/inngest/index.ts : Export nouveaux jobs

 √Ä Cr√©er (Nouveaux Fichiers)

 Configuration :
 - src/lib/email/resend.ts
 - src/lib/email/templates/quote-pdf.ts
 - src/lib/email/templates/invitation.ts
 - src/lib/email/templates/welcome.ts
 - src/lib/pdf/guest-quote-pdf.ts

 Modules :
 - src/modules/prospects/schemas/prospect.schema.ts
 - src/modules/prospects/actions/prospect.actions.ts
 - src/modules/prospects/index.ts
 - src/modules/guest-quotes/schemas/guest-quote.schema.ts
 - src/modules/guest-quotes/actions/guest-quote.actions.ts
 - src/modules/guest-quotes/index.ts
 - src/modules/pricing/data/standard-rates.ts
 - src/modules/pricing/actions/pricing.actions.ts
 - src/modules/pricing/schemas/pricing.schema.ts
 - src/modules/pricing/index.ts

 Jobs :
 - src/lib/inngest/functions/prospects.ts

 Composants :
 - src/components/quote-request/quote-request-modal.tsx
 - src/components/pricing-table/pricing-table.tsx
 - src/components/registration/complete-registration-form.tsx
 - src/components/registration/attach-to-account-form.tsx

 Pages :
 - src/app/(public)/tarifs/page.tsx
 - src/app/(public)/complete-registration/page.tsx

 ---
 ‚ö†Ô∏è Points d'Attention Critiques

 1. Actions Publiques vs Authentifi√©es

 - Actions publiques (prospects, guest-quotes) ‚Üí Utiliser prisma standard (pas enhanced)
 - Actions authentifi√©es (quotes, users) ‚Üí Utiliser getEnhancedPrismaFromSession(session)

 2. Cr√©ation de Company

 - Lors de la conversion, cr√©er automatiquement une Company par d√©faut
 - Utiliser les infos du prospect (name, email, country)
 - L'utilisateur pourra compl√©ter plus tard

 3. Workflow Better Auth

 - Cr√©ation User se fait c√¥t√© client avec signUp.email()
 - Server Actions pr√©parent (Company) et finalisent (conversion GuestQuotes)
 - Ordre : completeRegistrationAction ‚Üí signUp.email() ‚Üí finalizeProspectConversionAction

 4. Gestion des Doublons

 - Si email existe et status = EXPIRED ‚Üí R√©utiliser avec nouveau token
 - Si email existe et status = PENDING ‚Üí Ajouter GuestQuote au prospect existant
 - Si email existe et status = CONVERTED ‚Üí Erreur (utilisateur existe d√©j√†)

 5. S√©curit√© des Tokens

 - G√©n√©rer avec crypto.randomUUID() (secure, unique)
 - V√©rifier expiration avant toute action
 - Invalider apr√®s utilisation (status = CONVERTED)
 - Ne jamais exposer dans logs

 6. Format Num√©ros GuestQuote

 - Format : GQTE-YYYYMMDD-XXXXX (pr√©fixe G pour Guest)
 - V√©rifier unicit√© lors de la g√©n√©ration
 - Fallback avec timestamp si collision

 ---
 üìä Sch√©ma de Flux Complet

 UTILISATEUR NON-CONNECT√â
 ‚îÇ
 ‚îú‚îÄ‚Üí Calculateur (homepage)
 ‚îÇ   ‚îÇ
 ‚îÇ   ‚îú‚îÄ‚Üí Recevoir par email
 ‚îÇ   ‚îÇ   ‚îÇ
 ‚îÇ   ‚îÇ   ‚îî‚îÄ‚Üí QuoteRequestModal
 ‚îÇ   ‚îÇ       ‚îî‚îÄ‚Üí createProspectAndSendQuoteAction
 ‚îÇ   ‚îÇ           ‚îú‚îÄ‚Üí Cr√©er Prospect + GuestQuote
 ‚îÇ   ‚îÇ           ‚îú‚îÄ‚Üí G√©n√©rer PDF
 ‚îÇ   ‚îÇ           ‚îî‚îÄ‚Üí Envoyer email + lien invitation
 ‚îÇ   ‚îÇ
 ‚îÇ   ‚îî‚îÄ‚Üí Cr√©er un compte
 ‚îÇ       ‚îî‚îÄ‚Üí /register (normal)
 ‚îÇ
 ‚îî‚îÄ‚Üí Consulter tarifs (/tarifs)
     ‚îî‚îÄ‚Üí Cliquer "Utiliser ce mode"
         ‚îî‚îÄ‚Üí Redirection vers calculateur pr√©-rempli

 PROSPECT RE√áOIT EMAIL
 ‚îÇ
 ‚îî‚îÄ‚Üí Cliquer lien invitation
     ‚îî‚îÄ‚Üí /complete-registration?token=XXX
         ‚îÇ
         ‚îú‚îÄ‚Üí Email NOUVEAU
         ‚îÇ   ‚îî‚îÄ‚Üí CompleteRegistrationForm
         ‚îÇ       ‚îú‚îÄ‚Üí completeRegistrationAction (cr√©er Company)
         ‚îÇ       ‚îú‚îÄ‚Üí signUp.email (Better Auth)
         ‚îÇ       ‚îî‚îÄ‚Üí finalizeProspectConversionAction
         ‚îÇ           ‚îú‚îÄ‚Üí GuestQuote ‚Üí Quote
         ‚îÇ           ‚îú‚îÄ‚Üí Prospect status = CONVERTED
         ‚îÇ           ‚îî‚îÄ‚Üí Event Inngest ‚Üí Email bienvenue
         ‚îÇ
         ‚îî‚îÄ‚Üí Email EXISTE
             ‚îî‚îÄ‚Üí AttachToAccountForm
                 ‚îú‚îÄ‚Üí signIn.email (Better Auth)
                 ‚îî‚îÄ‚Üí finalizeProspectConversionAction
                     ‚îî‚îÄ‚Üí Rattachement GuestQuotes

 ---
 ‚úÖ Crit√®res de Succ√®s

 1. ‚úÖ Un utilisateur non-connect√© peut demander un devis et le recevoir par email
 2. ‚úÖ Le devis PDF contient toutes les informations calcul√©es
 3. ‚úÖ Le lien d'invitation fonctionne et expire apr√®s 7 jours
 4. ‚úÖ Un nouveau compte est cr√©√© avec Company automatique
 5. ‚úÖ Les GuestQuotes sont convertis en Quotes li√©s √† la Company
 6. ‚úÖ Un utilisateur existant peut rattacher ses devis √† son compte
 7. ‚úÖ Les jobs Inngest expirent et rappellent les prospects automatiquement
 8. ‚úÖ Le tableau de tarifs affiche les prix standards et redirige vers le calculateur
 9. ‚úÖ Les access policies Zenstack prot√®gent correctement les donn√©es
 10. ‚úÖ Tous les emails sont envoy√©s via Resend en production

 ---
 üöÄ Pour Commencer l'Impl√©mentation

 # 1. Modifier le sch√©ma
 vim schema.zmodel

 # 2. G√©n√©rer et pousser
 npm run db:generate
 npm run db:push

 # 3. Installer Resend
 npm install resend

 # 4. Configurer les variables d'environnement
 echo 'RESEND_API_KEY="re_xxxxx"' >> .env
 echo 'EMAIL_PROVIDER="console"' >> .env

 # 5. D√©marrer le d√©veloppement
 npm run dev

 # 6. D√©marrer Inngest Dev Server (terminal s√©par√©)
 npx inngest-cli@latest dev

 ---
 Dur√©e estim√©e totale : 15-20 heures de d√©veloppement

 Ordre de priorit√© :
 1. Sch√©ma + Configuration (critique)
 2. Modules prospects + guest-quotes (core)
 3. Composants UI (interface)
 4. Jobs Inngest (automatisation)
 5. Tests et validation (qualit√©)

