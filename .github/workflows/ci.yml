###############################################################################
# GitHub Actions Workflow - CI/CD Pipeline
#
# Pipeline automatis√©e pour Faso Fret Logistics v2
# Ex√©cut√©e automatiquement sur chaque push et pull request
#
# Jobs :
# 1. Tests unitaires et d'int√©gration (Vitest)
# 2. Tests sp√©cifiques pickups
# 3. Build Next.js
# 4. Linting ESLint
# 5. Upload rapport de couverture
#
# Triggers :
# - Push sur main/develop
# - Pull Request vers main/develop
# - Workflow dispatch (manuel)
#
# Variables d'environnement :
# - DATABASE_URL : D√©fini dans GitHub Secrets
# - BETTER_AUTH_SECRET : D√©fini dans GitHub Secrets
#
# @see https://docs.github.com/en/actions
###############################################################################

name: CI/CD Pipeline

# D√©clencheurs
on:
  # Ex√©cuter sur push vers main ou develop
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'

  # Ex√©cuter sur Pull Request vers main ou develop
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '*.md'
      - 'docs/**'

  # Permettre l'ex√©cution manuelle
  workflow_dispatch:

# Permissions requises
permissions:
  contents: read
  pull-requests: write
  checks: write

# Variables d'environnement globales
env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '8.x'

# Jobs de la pipeline
jobs:

  ###########################################################################
  # JOB 1 : Tests unitaires et d'int√©gration
  ###########################################################################
  test:
    name: üß™ Tests & Couverture
    runs-on: ubuntu-latest

    # Variables d'environnement pour les tests
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL_TEST }}
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET_TEST }}
      BETTER_AUTH_URL: http://localhost:3000
      NODE_ENV: test

    steps:
      # 1. Checkout du code
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Historique complet pour SonarCloud (optionnel)

      # 2. Setup Node.js avec cache npm
      - name: ‚öôÔ∏è Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3. Afficher les versions
      - name: üìä Versions
        run: |
          node --version
          npm --version
          echo "Runner OS: ${{ runner.os }}"

      # 4. Installer les d√©pendances
      - name: üì¶ Install dependencies
        run: npm ci

      # 5. G√©n√©rer les clients Prisma et Zenstack
      - name: üîß Generate Prisma & Zenstack clients
        run: npm run db:generate

      # 6. Linting ESLint
      - name: üîç Lint code
        run: npm run lint
        continue-on-error: false

      # 7. Ex√©cuter tous les tests avec couverture
      - name: üß™ Run all tests with coverage
        run: npm run test:coverage

      # 8. Upload rapport de couverture (artefact)
      - name: üìä Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      # 9. Commenter la PR avec le r√©sum√© de couverture
      - name: üí¨ Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: artiomtr/jest-coverage-report-action@v2
        with:
          coverage-file: coverage/coverage-summary.json
          test-script: npm run test:coverage
          annotations: failed-tests
          package-manager: npm

      # 10. V√©rifier les seuils de couverture
      - name: ‚úÖ Check coverage thresholds
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "Coverage report:"
            cat coverage/coverage-summary.json

            # Extraire le pourcentage de couverture (lignes)
            COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            echo "Line coverage: $COVERAGE%"

            # V√©rifier le seuil (70% minimum)
            if (( $(echo "$COVERAGE < 70" | bc -l) )); then
              echo "‚ùå Coverage is below 70% threshold!"
              exit 1
            else
              echo "‚úÖ Coverage meets the 70% threshold"
            fi
          fi

  ###########################################################################
  # JOB 2 : Tests sp√©cifiques pickups
  ###########################################################################
  test-pickups:
    name: üì¶ Tests Pickups
    runs-on: ubuntu-latest
    needs: test  # Ex√©cuter apr√®s les tests g√©n√©raux

    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL_TEST }}
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET_TEST }}
      BETTER_AUTH_URL: http://localhost:3000
      NODE_ENV: test

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîß Generate Prisma & Zenstack clients
        run: npm run db:generate

      - name: üì¶ Run pickup tests
        run: npm run test:pickups

  ###########################################################################
  # JOB 3 : Build Next.js
  ###########################################################################
  build:
    name: üèóÔ∏è Build Next.js
    runs-on: ubuntu-latest
    needs: test  # Ex√©cuter apr√®s les tests

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîß Generate Prisma & Zenstack clients
        run: npm run db:generate

      - name: üèóÔ∏è Build Next.js application
        run: npm run build
        env:
          # Variables d'environnement minimales pour le build
          DATABASE_URL: ${{ secrets.DATABASE_URL_TEST }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET_TEST }}
          BETTER_AUTH_URL: http://localhost:3000

      - name: üìä Build info
        run: |
          echo "Build completed successfully"
          ls -lh .next/
          du -sh .next/

      # Upload du build en artefact (optionnel)
      - name: üì¶ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: .next/
          retention-days: 7

  ###########################################################################
  # JOB 4 : Security Audit
  ###########################################################################
  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üîí Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: üîç Check for known vulnerabilities
        run: |
          echo "Checking for critical vulnerabilities..."
          AUDIT_RESULT=$(npm audit --json)
          HIGH_VULNS=$(echo $AUDIT_RESULT | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(echo $AUDIT_RESULT | jq '.metadata.vulnerabilities.critical // 0')

          echo "High vulnerabilities: $HIGH_VULNS"
          echo "Critical vulnerabilities: $CRITICAL_VULNS"

          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "‚ùå Critical vulnerabilities found!"
            exit 1
          fi

  ###########################################################################
  # JOB 5 : Summary & Notifications
  ###########################################################################
  summary:
    name: üìä Summary
    runs-on: ubuntu-latest
    needs: [test, test-pickups, build, security]
    if: always()

    steps:
      - name: üìä Generate summary
        run: |
          echo "## üéØ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests & Coverage | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pickup Tests | ${{ needs.test-pickups.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Next.js | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      # Notification Slack (optionnel)
      - name: üì¢ Slack notification
        if: failure() && github.ref == 'refs/heads/main'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            üö® CI/CD Pipeline Failed
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Branch: ${{ github.ref_name }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
